<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard - OndeCompensa</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2e7d32">
    <meta name="mobile-web-app-capable" content="yes">

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f4f7fa; margin: 0; padding: 20px; padding-bottom: 100px; }
        
        /* CABE√áALHO */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .user-info h2 { margin: 0; color: #333; font-size: 1.4rem; }
        .user-info p { margin: 0; color: #666; font-size: 0.9rem; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; background: #ddd; object-fit: cover; border: 2px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); cursor: pointer; }

        /* CARDS */
        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 20px; }
        .card-title { font-size: 0.9rem; font-weight: 700; color: #888; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 0.5px; }

        /* A√á√ïES R√ÅPIDAS (Bot√µes grandes no topo) */
        .quick-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .action-card { 
            background: white; padding: 20px; border-radius: 16px; text-align: center; 
            text-decoration: none; color: #333; box-shadow: 0 4px 15px rgba(0,0,0,0.03); 
            transition: transform 0.1s; display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .action-card:active { transform: scale(0.98); }
        .icon-large { font-size: 2rem; }
        .action-label { font-weight: 600; font-size: 0.95rem; }

        /* BOT√ïES FLUTUANTES (Menu Inferior) */
        .fab-container {
            position: fixed; bottom: 25px; right: 25px; 
            display: flex; flex-direction: column; gap: 15px; z-index: 90; align-items: center;
        }
        .fab {
            width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            text-decoration: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-size: 22px; transition: 0.2s;
            background: white; position: relative;
        }
        .fab:active { transform: scale(0.90); }
        
        .fab-main { 
            background: #2e7d32; color: white; width: 60px; height: 60px; font-size: 30px; 
            box-shadow: 0 4px 20px rgba(46, 125, 50, 0.4); 
        }

        /* --- TUTORIAL (O NOVO RECURSO) --- */
        .tour-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 999; display: none;
            clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%); /* Ser√° modificado via JS */
        }
        
        .tour-box {
            position: fixed; background: white; padding: 20px; border-radius: 16px; width: 280px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3); z-index: 1000; display: none;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .tour-box h3 { margin: 0 0 10px 0; color: #2e7d32; font-size: 1.1rem; }
        .tour-box p { margin: 0 0 20px 0; color: #555; line-height: 1.5; font-size: 0.95rem; }
        .tour-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .btn-skip { background: none; border: none; color: #999; font-weight: 600; cursor: pointer; }
        .btn-next { background: #2e7d32; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* Destaque do elemento focado */
        .highlight-ring {
            position: fixed; border: 4px solid #fff; border-radius: 50%; 
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.7); /* Truque para escurecer o resto */
            pointer-events: none; z-index: 998; display: none; transition: all 0.3s;
        }

        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div class="header">
        <div class="user-info">
            <h2 id="txt-saudacao">Ol√°! üëã</h2>
            <p id="txt-cidade">Carregando...</p>
        </div>
        <a href="perfil.html" id="btn-perfil">
            <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" class="avatar" id="img-avatar">
        </a>
    </div>

    <div class="quick-actions">
        <a href="importar.html" class="action-card" id="btn-importar">
            <span class="icon-large">üì∏</span>
            <span class="action-label">Ler Encarte</span>
        </a>
        <a href="calculadora.html" class="action-card" id="btn-dash-calc">
            <span class="icon-large">üßÆ</span>
            <span class="action-label">Calculadora</span>
        </a>
    </div>

    <div class="card">
        <div class="card-title">Gasto Mensal</div>
        <canvas id="graficoGastos" height="150"></canvas>
    </div>

    <div class="fab-container">
        <a href="calculadora.html" class="fab" id="btn-calc" style="color:#007bff; border:2px solid #007bff;">üßÆ</a>
        <a href="lista.html" class="fab" id="btn-lista" style="color:#2e7d32; border:2px solid #2e7d32;">üìù</a>
        <a href="oferta.html" class="fab" id="btn-ofertas" style="color:#d32f2f; border:2px solid #d32f2f;">üî•</a>
        <a href="nova-nota.html" class="fab fab-main" id="btn-nova">Ôºã</a>
    </div>

    <div class="highlight-ring" id="tour-ring"></div>
    <div class="tour-box" id="tour-box">
        <h3 id="tour-title">T√≠tulo</h3>
        <p id="tour-desc">Descri√ß√£o</p>
        <div class="tour-actions">
            <button class="btn-skip" onclick="encerrarTour()">Pular</button>
            <button class="btn-next" onclick="proximoPasso()">Pr√≥ximo ‚ûú</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://sjhvftndaplufqnrjxcs.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqaHZmdG5kYXBsdWZxbnJqeGNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MDYxMDgsImV4cCI6MjA4MzM4MjEwOH0.bNstvXQ7m2Zt-0UatKmdkxM95-Ft4SRBc1JGGITSnzk';
        const cliente = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- L√≥gica do App ---
        async function iniciar() {
            const { data: { session } } = await cliente.auth.getSession();
            if(!session) return window.location.href = 'login.html';

            const user = session.user;
            document.getElementById('txt-saudacao').innerText = `Ol√°, ${user.user_metadata.full_name?.split(' ')[0] || 'Visitante'}!`;
            if(user.user_metadata.avatar_url) document.getElementById('img-avatar').src = user.user_metadata.avatar_url;

            // Busca cidade no perfil
            let { data: perfil } = await cliente.from('profiles').select('city').eq('id', user.id).single();
            if(perfil && perfil.city) {
                document.getElementById('txt-cidade').innerText = `üìç ${perfil.city}`;
                localStorage.setItem('minhaCidade', perfil.city);
            } else {
                document.getElementById('txt-cidade').innerText = `üìç Selecione sua cidade`;
            }

            // Inicia o Tour se for a primeira vez
            verificarTour();
        }

        // --- SISTEMA DE TOUR INTERATIVO ---
        const passosTour = [
            {
                id: 'btn-importar',
                titulo: 'üì∏ Leitor de Encartes',
                texto: 'Tirou foto do encarte do mercado? A nossa Intelig√™ncia Artificial l√™ tudo e cadastra as ofertas pra voc√™.'
            },
            {
                id: 'btn-calc', // Calculadora no menu flutuante
                titulo: 'üßÆ Calculadora de Carrinho',
                texto: 'N√£o estoure a meta! Use a calculadora enquanto faz compras. Ela at√© sugere se o pre√ßo est√° bom.'
            },
            {
                id: 'btn-lista',
                titulo: 'üìù Lista Inteligente',
                texto: 'Monte sua lista aqui. O app vai te dizer em qual mercado esses itens est√£o mais baratos.'
            },
            {
                id: 'btn-ofertas',
                titulo: 'üî• Ofertas da Regi√£o',
                texto: 'Veja o que outros usu√°rios encontraram de barato na sua cidade hoje.'
            },
            {
                id: 'btn-nova',
                titulo: 'Ôºã Adicionar Nota',
                texto: 'Comprou algo que n√£o estava no encarte? Lance a nota fiscal aqui rapidinho.'
            },
            {
                id: 'btn-perfil',
                titulo: 'üë§ Seu Perfil',
                texto: 'Aqui voc√™ define sua Cidade e sua Meta de gastos mensal.'
            }
        ];

        let passoAtual = 0;

        function verificarTour() {
            // Se n√£o tiver a marca√ß√£o 'tourVisto' no navegador, come√ßa o tour
            if (!localStorage.getItem('tourVistoV1')) {
                setTimeout(() => mostrarPasso(0), 1000); // Espera 1seg para carregar a tela
            }
        }

        function mostrarPasso(index) {
            if (index >= passosTour.length) {
                encerrarTour();
                return;
            }

            const passo = passosTour[index];
            const el = document.getElementById(passo.id);
            
            if (!el) { // Se o elemento n√£o existir na tela, pula
                proximoPasso(); 
                return; 
            }

            // 1. Posiciona o Anel de Destaque
            const rect = el.getBoundingClientRect();
            const ring = document.getElementById('tour-ring');
            const box = document.getElementById('tour-box');

            ring.style.display = 'block';
            ring.style.width = (rect.width + 10) + 'px';
            ring.style.height = (rect.height + 10) + 'px';
            ring.style.top = (rect.top - 5) + 'px';
            ring.style.left = (rect.left - 5) + 'px';
            ring.style.borderRadius = window.getComputedStyle(el).borderRadius;

            // 2. Preenche o Texto
            document.getElementById('tour-title').innerText = passo.titulo;
            document.getElementById('tour-desc').innerText = passo.texto;

            // 3. Posiciona a Caixa de Texto (Inteligente)
            box.style.display = 'block';
            
            // Se o elemento estiver muito embaixo (como os bot√µes flutuantes), mostra a caixa em cima
            if (rect.top > window.innerHeight / 2) {
                box.style.bottom = (window.innerHeight - rect.top + 20) + 'px';
                box.style.top = 'auto';
                box.style.right = '20px'; // Alinha a direita
            } else {
                // Se estiver no topo, mostra a caixa embaixo
                box.style.top = (rect.bottom + 20) + 'px';
                box.style.bottom = 'auto';
                box.style.left = '20px';
            }

            passoAtual = index;
        }

        function proximoPasso() {
            passoAtual++;
            mostrarPasso(passoAtual);
        }

        function encerrarTour() {
            document.getElementById('tour-ring').style.display = 'none';
            document.getElementById('tour-box').style.display = 'none';
            localStorage.setItem('tourVistoV1', 'true'); // Marca que j√° viu
        }

        // --- Renderiza Gr√°fico Fake para visual ---
        const ctx = document.getElementById('graficoGastos').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'],
                datasets: [{
                    label: 'Gastos (R$)',
                    data: [150, 230, 180, 90],
                    backgroundColor: '#2e7d32',
                    borderRadius: 5
                }]
            },
            options: { scales: { y: { beginAtZero: true } } }
        });

        // Service Worker
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js'); }); }

        iniciar();
    </script>
</body>
</html>