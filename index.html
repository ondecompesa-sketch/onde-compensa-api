<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minhas Compras</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* Reset e Base */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 0; padding-bottom: 80px; color: #333; }
        
        /* Container Principal */
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        
        /* Header Fixo no Topo (Estilo App) */
        .app-header {
            display: flex; justify-content: space-between; align-items: center;
            background: #fff; padding: 15px 20px;
            position: sticky; top: 0; z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-bottom-left-radius: 16px; border-bottom-right-radius: 16px;
        }
        .app-title { font-size: 1.2rem; font-weight: 800; color: #007bff; margin: 0; }
        .btn-icon { background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 5px; }

        /* Resumo (Cards Superiores) */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .stat-card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); text-align: center; }
        .stat-val { font-size: 1.1rem; font-weight: bold; color: #2e7d32; display: block; }
        .stat-lbl { font-size: 0.75rem; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Gr√°fico Compacto */
        .chart-container { background: white; margin-top: 15px; padding: 15px; border-radius: 12px; height: 200px; position: relative; }

        /* Filtro e Busca */
        .controls-area { margin-top: 15px; display: flex; gap: 10px; }
        .search-input { flex: 1; padding: 12px; border: none; border-radius: 10px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.03); font-size: 1rem; }
        .filter-select { padding: 10px; border: none; border-radius: 10px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.03); font-weight: bold; color: #555; }

        /* LISTA DE COMPRAS (Estilo Instagram/Feed) */
        .receipt-list { margin-top: 20px; list-style: none; padding: 0; }
        
        .receipt-card {
            background: white; border-radius: 16px; padding: 15px; margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            display: flex; flex-direction: column; gap: 10px;
            position: relative; overflow: hidden;
        }
        
        /* Detalhe colorido na esquerda */
        .receipt-card::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px;
            background: #007bff;
        }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .store-name { font-weight: 700; font-size: 1.1rem; color: #333; }
        .card-date { font-size: 0.8rem; color: #999; }
        
        .card-body { display: flex; justify-content: space-between; align-items: center; }
        .item-count { font-size: 0.9rem; color: #666; background: #f0f2f5; padding: 4px 8px; border-radius: 6px; }
        .total-price { font-size: 1.3rem; font-weight: 800; color: #2e7d32; }

        .card-actions { 
            border-top: 1px solid #f0f0f0; padding-top: 10px; margin-top: 5px;
            display: flex; gap: 10px; 
        }
        .btn-action {
            flex: 1; padding: 10px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .btn-view { background: #e3f2fd; color: #1565c0; }
        .btn-del { background: #ffebee; color: #c62828; max-width: 50px; }

        /* Bot√£o Flutuante (FAB) para Nova Nota */
        .fab {
            position: fixed; bottom: 20px; right: 20px;
            background: #007bff; color: white;
            width: 60px; height: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; box-shadow: 0 4px 15px rgba(0,123,255,0.4);
            text-decoration: none; z-index: 200;
        }
        .fab:active { transform: scale(0.95); }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: flex-end; }
        .modal-content { 
            background: white; width: 100%; max-height: 90vh; 
            border-top-left-radius: 20px; border-top-right-radius: 20px; 
            padding: 25px; overflow-y: auto; 
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { margin: 0; font-size: 1.3rem; }
        
        .item-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }
        .item-name { font-weight: 500; }
        .item-sub { font-size: 0.8rem; color: #888; margin-top: 2px; }
        .item-price { font-weight: bold; }
        
        .empty-state { text-align: center; padding: 40px; color: #999; }
        .menu-dropdown { position: absolute; top: 60px; right: 20px; background: white; padding: 10px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); display: none; flex-direction: column; gap: 5px; z-index: 101; }
    </style>
</head>
<body>

<div class="app-header">
    <button class="btn-icon" onclick="window.location.href='perfil.html'">üë§</button>
    <h1 class="app-title">OndeCompensa</h1>
    <button class="btn-icon" onclick="toggleMenu()">‚ãÆ</button>
    
    <div id="menuDropdown" class="menu-dropdown">
        <button onclick="fazerFaxina()" style="background:none; border:none; padding:10px; text-align:left; color:#d32f2f;">üßπ Limpar Erros</button>
        <button onclick="sair()" style="background:none; border:none; padding:10px; text-align:left;">üö™ Sair</button>
    </div>
</div>

<div class="container">
    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-lbl">Total Gasto</span>
            <span class="stat-val" id="total-geral">R$ 0,00</span>
        </div>
        <div class="stat-card">
            <span class="stat-lbl">Top Categoria</span>
            <span class="stat-val" id="top-categoria" style="color:#007bff">---</span>
        </div>
    </div>

    <div class="chart-container">
        <canvas id="meuGrafico"></canvas>
    </div>

    <div class="controls-area">
        <input type="text" class="search-input" placeholder="üîç Buscar produto..." onkeyup="buscar(this.value)">
        <select id="filtro-mes" class="filter-select" onchange="filtrarEAtualizar()">
            <option value="todos">üìÖ</option>
        </select>
    </div>
    <div id="area-busca" style="margin-top:10px; background:white; border-radius:10px; display:none;"></div>

    <div id="lista-compras" class="receipt-list">
        </div>
</div>

<a href="nova-nota.html" class="fab">Ôºã</a>

<div id="modalDetalhes" class="modal-overlay" onclick="fecharModal(event)">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="modal-titulo">Detalhes</h2>
            <button onclick="fecharModal(null)" style="background:none; border:none; font-size:1.5rem;">&times;</button>
        </div>
        <div id="lista-itens-modal"></div>
        <div style="margin-top:20px; text-align:right; font-size:1.5rem; font-weight:800; color:#2e7d32;" id="modal-total"></div>
    </div>
</div>

<script>
    // --- ‚ö†Ô∏è SUAS CHAVES DO SUPABASE (PREENCHA AQUI) ---
    const SUPABASE_URL = 'https://sjhvftndaplufqnrjxcs.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqaHZmdG5kYXBsdWZxbnJqeGNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MDYxMDgsImV4cCI6MjA4MzM4MjEwOH0.bNstvXQ7m2Zt-0UatKmdkxM95-Ft4SRBc1JGGITSnzk';
    // -----------------------------------------------

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let todasAsCompras = [];
    let chartInstance = null;
    let userId = null;

    async function iniciar() {
        const { data } = await supabaseClient.auth.getSession();
        if (!data.session) return window.location.href = 'login.html';
        
        userId = data.session.user.id;
        
        // Verifica perfil
        const { data: perfil } = await supabaseClient.from('profiles').select('*').eq('id', userId).single();
        if (!perfil || !perfil.bairro) { window.location.href = 'perfil.html'; return; }

        carregar();
    }

    async function carregar() {
        try {
            document.getElementById('lista-compras').innerHTML = '<div class="empty-state">‚è≥ Carregando suas compras...</div>';
            const res = await fetch(`https://onde-compensa-api.onrender.com/receipts?userId=${userId}`);
            todasAsCompras = await res.json();
            preencherFiltroMeses();
            filtrarEAtualizar();
        } catch(e) { console.error("Erro:", e); }
    }

    function preencherFiltroMeses() {
        const select = document.getElementById('filtro-mes');
        const meses = new Set();
        todasAsCompras.forEach(n => {
            const d = new Date(n.issue_date);
            meses.add(`${d.getMonth() + 1}/${d.getFullYear()}`);
        });
        select.innerHTML = '<option value="todos">üìÖ Todo Per√≠odo</option>';
        Array.from(meses).sort().reverse().forEach(m => {
            select.innerHTML += `<option value="${m}">${m}</option>`;
        });
    }

    function filtrarEAtualizar() {
        const select = document.getElementById('filtro-mes');
        const mesEscolhido = select.value;
        const comprasFiltradas = todasAsCompras.filter(n => {
            if (mesEscolhido === 'todos') return true;
            const d = new Date(n.issue_date);
            return `${d.getMonth() + 1}/${d.getFullYear()}` === mesEscolhido;
        });
        renderizarLista(comprasFiltradas);
        calcularEstatisticas(comprasFiltradas);
    }

    function renderizarLista(dados) {
        const container = document.getElementById('lista-compras');
        container.innerHTML = '';
        
        if (dados.length === 0) return container.innerHTML = '<div class="empty-state">üì¶ Nenhuma compra encontrada neste per√≠odo.</div>';
        
        dados.forEach(nota => {
            const data = new Date(nota.issue_date).toLocaleDateString('pt-BR');
            const total = parseFloat(nota.total_amount).toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            const nomeLoja = nota.store?.name || nota.stores?.name || 'Loja Desconhecida';
            
            // Cria o Card
            const card = document.createElement('div');
            card.className = 'receipt-card';
            card.innerHTML = `
                <div class="card-header">
                    <span class="store-name">${nomeLoja}</span>
                    <span class="card-date">${data}</span>
                </div>
                <div class="card-body">
                    <span class="item-count">${nota.receipt_items.length} itens</span>
                    <span class="total-price">${total}</span>
                </div>
                <div class="card-actions">
                    <button class="btn-action btn-view" onclick="abrirNotaPorId('${nota.id}')">üìÑ Ver Detalhes</button>
                    <button class="btn-action btn-del" onclick="deletarNota('${nota.id}')">üóëÔ∏è</button>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function calcularEstatisticas(dados) {
        let gastosPorCategoria = {};
        let totalGeral = 0;
        dados.forEach(nota => {
            totalGeral += parseFloat(nota.total_amount);
            nota.receipt_items.forEach(item => {
                let cat = item.product?.category || item.products?.category || 'Outros';
                if (!gastosPorCategoria[cat]) gastosPorCategoria[cat] = 0;
                gastosPorCategoria[cat] += parseFloat(item.total_price);
            });
        });

        document.getElementById('total-geral').innerText = totalGeral.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
        let topCat = '-'; let maxVal = 0;
        for (const [cat, val] of Object.entries(gastosPorCategoria)) { if (val > maxVal) { maxVal = val; topCat = cat; } }
        document.getElementById('top-categoria').innerText = topCat;

        const ctx = document.getElementById('meuGrafico').getContext('2d');
        const labels = Object.keys(gastosPorCategoria);
        const values = Object.values(gastosPorCategoria);
        const cores = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1', '#17a2b8', '#fd7e14', '#6c757d'];

        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: labels, datasets: [{ data: values, backgroundColor: cores, borderWidth: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false } } }
        });
    }

    function abrirNotaPorId(id) {
        const nota = todasAsCompras.find(n => n.id === id);
        if(!nota) return;
        
        const nomeLoja = nota.store?.name || nota.stores?.name || 'Loja';
        document.getElementById('modal-titulo').innerText = nomeLoja;
        
        let html = '';
        nota.receipt_items.forEach(i => {
            const cat = i.product?.category || i.products?.category || 'Outros';
            html += `
                <div class="item-row">
                    <div>
                        <div class="item-name">${i.raw_name}</div>
                        <div class="item-sub">${i.quantity} ${i.unit_measure || 'UN'} ‚Ä¢ ${cat}</div>
                    </div>
                    <div class="item-price">${parseFloat(i.total_price).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</div>
                </div>`;
        });
        
        document.getElementById('lista-itens-modal').innerHTML = html;
        document.getElementById('modal-total').innerText = parseFloat(nota.total_amount).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
        document.getElementById('modalDetalhes').style.display = 'flex';
    }

    // Busca e Outras Fun√ß√µes
    async function buscar(texto) {
        const area = document.getElementById('area-busca');
        if(texto.length < 3) { area.style.display='none'; return; }
        
        const res = await fetch(`https://onde-compensa-api.onrender.com/search?q=${texto}&userId=${userId}`);
        const prods = await res.json();
        
        area.innerHTML = ''; area.style.display = 'block';
        if(prods.length===0) area.innerHTML='<div style="padding:15px; color:#666; text-align:center">Nenhum produto encontrado.</div>';
        
        prods.forEach(p => {
            const pr = parseFloat(p.unit_price).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            const nomeLoja = p.receipt?.store?.name || p.receipt?.stores?.name || 'Loja';
            area.innerHTML += `
                <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;" onclick="abrirNotaPorId('${p.receipt_id}')">
                    <div>
                        <div style="font-weight:600">${p.raw_name}</div>
                        <div style="font-size:0.8rem; color:#888">${nomeLoja}</div>
                    </div>
                    <div style="font-weight:bold; color:#2e7d32">${pr}</div>
                </div>`;
        });
    }

    function toggleMenu() { const m = document.getElementById('menuDropdown'); m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; }
    function fecharModal(e) { if(!e || e.target.className.includes('modal') || e.target.tagName==='BUTTON') document.getElementById('modalDetalhes').style.display='none'; }
    async function deletarNota(id) { if(confirm('Deseja apagar esta nota?')) { await fetch(`https://onde-compensa-api.onrender.com/receipts/${id}`, {method:'DELETE'}); carregar(); } }
    async function fazerFaxina() { if(confirm('Limpar notas com erro?')) { await fetch('https://onde-compensa-api.onrender.com/cleanup', {method:'DELETE'}); carregar(); } }
    async function sair() { await supabaseClient.auth.signOut(); window.location.href = 'login.html'; }

    iniciar();
</script>
</body>
</html>