<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard - OndeCompensa</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="mobile-web-app-capable" content="yes">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #f4f7fa; margin: 0; padding: 0; padding-bottom: 90px; color: #333; }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }

        /* CABE√áALHO */
        .app-header { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 15px 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 15px rgba(0,0,0,0.04); border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; }
        .user-profile { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .avatar-img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid #e0e0e0; }
        .user-texts { display: flex; flex-direction: column; }
        .greeting { font-size: 0.8rem; color: #888; }
        .user-name { font-size: 1rem; font-weight: 700; color: #333; }
        .header-actions { display: flex; align-items: center; gap: 8px; }
        .btn-calc-mini { background: #e3f2fd; color: #007bff; border: none; width: 40px; height: 40px; border-radius: 12px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-menu { background: none; border: none; font-size: 1.5rem; color: #333; cursor: pointer; padding: 0 5px; }
        .menu-dropdown { position: absolute; top: 70px; right: 20px; background: white; padding: 10px; border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.15); display: none; flex-direction: column; gap: 5px; z-index: 200; min-width: 150px; }
        .menu-item { background: none; border: none; padding: 12px; text-align: left; font-size: 0.95rem; color: #333; border-radius: 8px; cursor: pointer; }
        .menu-danger { color: #d32f2f; }

        /* DASHBOARD */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; }
        .stat-card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); text-align: center; }
        .stat-val { font-size: 1.2rem; font-weight: 800; color: #2e7d32; display: block; margin-top: 5px; }
        .stat-lbl { font-size: 0.75rem; color: #999; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .chart-container { background: white; margin-top: 15px; padding: 20px; border-radius: 16px; height: 220px; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        
        /* BUSCA */
        .controls-area { margin-top: 20px; display: flex; gap: 10px; }
        .search-input { flex: 1; padding: 14px; border: none; border-radius: 12px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.03); font-size: 1rem; outline: none; }
        .filter-select { padding: 10px; border: none; border-radius: 12px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.03); font-weight: bold; color: #555; outline: none; }
        
        /* RANKING CARD (ATUALIZADO) */
        #area-busca { margin-top:10px; display:none; flex-direction:column; gap:10px; }
        .rank-card { background: white; padding: 15px; border-radius: 14px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid transparent; animation: fadeIn 0.3s; position: relative; }
        
        .rank-1 { border-left-color: #ffd700; background: linear-gradient(to right, #fffae6, #fff); }
        .rank-2 { border-left-color: #c0c0c0; }
        .rank-3 { border-left-color: #cd7f32; }
        
        .rank-content { flex: 1; display: flex; align-items: center; cursor: pointer; } /* √Årea clic√°vel p/ nota */
        .rank-badge { font-size: 1.5rem; margin-right: 10px; }
        .rank-info h3 { margin: 0; font-size: 1rem; color: #333; }
        .rank-info p { margin: 2px 0 0 0; font-size: 0.8rem; color: #666; }
        
        .rank-actions { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
        .price-big { font-size: 1.1rem; font-weight: 800; color: #2e7d32; }
        .price-date { font-size: 0.7rem; color: #999; }
        .old-price { color: #d32f2f; font-weight: bold; }
        
        /* Novo Bot√£o de Adicionar ao Carrinho */
        .btn-to-calc {
            background: #007bff; color: white; border: none;
            padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold;
            display: flex; align-items: center; gap: 5px; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,123,255,0.3); transition: transform 0.1s;
        }
        .btn-to-calc:active { transform: scale(0.95); }

        /* LISTA */
        .receipt-list { margin-top: 25px; display: flex; flex-direction: column; gap: 15px; }
        .receipt-card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); position: relative; overflow: hidden; }
        .receipt-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; background: #007bff; }
        .card-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .store-name { font-weight: 700; font-size: 1.1rem; color: #333; }
        .card-date { font-size: 0.85rem; color: #999; }
        .card-body { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 15px; }
        .total-price { font-size: 1.4rem; font-weight: 800; color: #333; }
        .card-actions { display: flex; gap: 10px; }
        .btn-action { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; font-size: 0.9rem; }
        .btn-view { background: #e3f2fd; color: #1565c0; }
        .btn-del { background: #ffebee; color: #c62828; flex: 0 0 50px; }

        .fab { position: fixed; bottom: 25px; right: 25px; background: #007bff; color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 4px 20px rgba(0,123,255,0.4); text-decoration: none; z-index: 90; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: flex-end; }
        .modal-content { background: white; width: 100%; max-height: 85vh; border-top-left-radius: 25px; border-top-right-radius: 25px; padding: 25px; overflow-y: auto; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .item-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f5f5f5; }
        .empty-state { text-align: center; padding: 50px 20px; color: #999; }
    </style>
</head>
<body>

<div class="app-header">
    <div class="user-profile" onclick="window.location.href='perfil.html'">
        <img id="user-avatar" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" class="avatar-img">
        <div class="user-texts">
            <span class="greeting">Ol√°,</span>
            <span class="user-name" id="user-name">Visitante</span>
        </div>
    </div>
    <div class="header-actions">
        <button onclick="window.location.href='calculadora.html'" class="btn-calc-mini" title="Calculadora">üßÆ</button>
        <button class="btn-menu" onclick="toggleMenu()">‚ãÆ</button>
    </div>
    <div id="menuDropdown" class="menu-dropdown">
        <button class="menu-item" onclick="fazerFaxina()">üßπ Limpar Erros</button>
        <button class="menu-item menu-danger" onclick="sair()">üö™ Sair da Conta</button>
    </div>
</div>

<div class="container">
    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-lbl">Gasto no M√™s</span>
            <span class="stat-val" id="total-geral">R$ 0,00</span>
        </div>
        <div class="stat-card">
            <span class="stat-lbl">Top Categoria</span>
            <span class="stat-val" id="top-categoria" style="color:#007bff">---</span>
        </div>
    </div>

    <div class="chart-container">
        <canvas id="meuGrafico"></canvas>
    </div>

    <div class="controls-area">
        <input type="text" class="search-input" placeholder="üîç Comparar (ex: Leite)..." onkeyup="buscar(this.value)">
        <select id="filtro-mes" class="filter-select" onchange="filtrarEAtualizar()">
            <option value="todos">üìÖ</option>
        </select>
    </div>
    
    <div id="area-busca"></div>

    <div id="lista-compras" class="receipt-list"></div>
</div>

<a href="nova-nota.html" class="fab">Ôºã</a>

<div id="modalDetalhes" class="modal-overlay" onclick="fecharModal(event)">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0; font-size:1.4rem; color:#333;" id="modal-titulo">Detalhes</h2>
            <button onclick="fecharModal(null)" style="background:#f0f2f5; border:none; width:35px; height:35px; border-radius:50%; font-weight:bold; cursor:pointer;">‚úï</button>
        </div>
        <div id="lista-itens-modal"></div>
        <div style="margin-top:25px; padding-top:15px; border-top:2px dashed #eee; display:flex; justify-content:space-between; align-items:center;">
            <span style="color:#666;">Total da Nota</span>
            <span style="font-size:1.6rem; font-weight:800; color:#2e7d32;" id="modal-total"></span>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://sjhvftndaplufqnrjxcs.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqaHZmdG5kYXBsdWZxbnJqeGNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MDYxMDgsImV4cCI6MjA4MzM4MjEwOH0.bNstvXQ7m2Zt-0UatKmdkxM95-Ft4SRBc1JGGITSnzk';
    
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let todasAsCompras = [];
    let chartInstance = null;
    let userId = null;

    async function iniciar() {
        const { data } = await supabaseClient.auth.getSession();
        if (!data.session) return window.location.href = 'login.html';
        
        const user = data.session.user;
        userId = user.id;

        const nomeCompleto = user.user_metadata.full_name || user.user_metadata.name || user.email;
        const primeiroNome = nomeCompleto.split(' ')[0];
        const foto = user.user_metadata.avatar_url || user.user_metadata.picture;

        document.getElementById('user-name').innerText = primeiroNome;
        if (foto) document.getElementById('user-avatar').src = foto;
        
        carregar();
    }

    async function carregar() {
        try {
            document.getElementById('lista-compras').innerHTML = '<div class="empty-state">‚è≥ Atualizando...</div>';
            const res = await fetch(`https://onde-compensa-api.onrender.com/receipts?userId=${userId}`);
            todasAsCompras = await res.json();
            preencherFiltroMeses();
            filtrarEAtualizar();
        } catch(e) { console.error("Erro:", e); }
    }

    function preencherFiltroMeses() {
        const select = document.getElementById('filtro-mes');
        const meses = new Set();
        todasAsCompras.forEach(n => {
            const d = new Date(n.issue_date);
            meses.add(`${d.getMonth() + 1}/${d.getFullYear()}`);
        });
        select.innerHTML = '<option value="todos">üìÖ Todos</option>';
        Array.from(meses).sort().reverse().forEach(m => {
            select.innerHTML += `<option value="${m}">${m}</option>`;
        });
    }

    function filtrarEAtualizar() {
        const select = document.getElementById('filtro-mes');
        const mesEscolhido = select.value;
        const comprasFiltradas = todasAsCompras.filter(n => {
            if (mesEscolhido === 'todos') return true;
            const d = new Date(n.issue_date);
            return `${d.getMonth() + 1}/${d.getFullYear()}` === mesEscolhido;
        });
        renderizarLista(comprasFiltradas);
        calcularEstatisticas(comprasFiltradas);
    }

    function renderizarLista(dados) {
        const container = document.getElementById('lista-compras');
        container.innerHTML = '';
        if (dados.length === 0) return container.innerHTML = '<div class="empty-state">üì¶ Nenhuma compra neste per√≠odo.</div>';
        dados.sort((a, b) => new Date(b.issue_date) - new Date(a.issue_date));
        dados.forEach(nota => {
            const dataObj = new Date(nota.issue_date);
            const dataFmt = dataObj.toLocaleDateString('pt-BR', {day:'2-digit', month:'short'});
            const total = parseFloat(nota.total_amount).toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            const nomeLoja = nota.store?.name || nota.stores?.name || 'Loja Desconhecida';
            
            const card = document.createElement('div');
            card.className = 'receipt-card';
            card.innerHTML = `
                <div class="card-header">
                    <span class="store-name">${nomeLoja}</span>
                    <span class="card-date">${dataFmt}</span>
                </div>
                <div class="card-body">
                    <span style="color:#666; font-size:0.9rem;">${nota.receipt_items.length} itens</span>
                    <span class="total-price">${total}</span>
                </div>
                <div class="card-actions">
                    <button class="btn-action btn-view" onclick="abrirNotaPorId('${nota.id}')">üìÑ Detalhes</button>
                    <button class="btn-action btn-del" onclick="deletarNota('${nota.id}')">üóëÔ∏è</button>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function calcularEstatisticas(dados) {
        let gastosPorCategoria = {};
        let totalGeral = 0;
        dados.forEach(nota => {
            totalGeral += parseFloat(nota.total_amount);
            nota.receipt_items.forEach(item => {
                let cat = item.product?.category || item.products?.category || 'Outros';
                if (!gastosPorCategoria[cat]) gastosPorCategoria[cat] = 0;
                gastosPorCategoria[cat] += parseFloat(item.total_price);
            });
        });
        document.getElementById('total-geral').innerText = totalGeral.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
        let topCat = '-'; let maxVal = 0;
        for (const [cat, val] of Object.entries(gastosPorCategoria)) { if (val > maxVal) { maxVal = val; topCat = cat; } }
        document.getElementById('top-categoria').innerText = topCat;
        atualizarGrafico(gastosPorCategoria);
    }

    function atualizarGrafico(dadosCat) {
        const ctx = document.getElementById('meuGrafico').getContext('2d');
        const labels = Object.keys(dadosCat);
        const values = Object.values(dadosCat);
        const cores = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6'];
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: labels, datasets: [{ data: values, backgroundColor: cores, borderWidth: 0, hoverOffset: 10 }] },
            options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: false } } }
        });
    }

    function abrirNotaPorId(id) {
        const nota = todasAsCompras.find(n => n.id === id);
        if(!nota) return;
        const nomeLoja = nota.store?.name || nota.stores?.name || 'Loja';
        const dataFmt = new Date(nota.issue_date).toLocaleDateString('pt-BR');
        document.getElementById('modal-titulo').innerText = nomeLoja;
        let html = `<div style="text-align:center; color:#888; margin-bottom:15px; font-size:0.9rem;">üìÖ ${dataFmt}</div>`;
        nota.receipt_items.forEach(i => {
            const cat = i.product?.category || i.products?.category || 'Geral';
            html += `
                <div class="item-row">
                    <div style="flex:1">
                        <div style="font-weight:600; color:#333;">${i.raw_name}</div>
                        <div style="font-size:0.8rem; color:#999; margin-top:2px;">${i.quantity} ${i.unit_measure || 'un'} ‚Ä¢ ${cat}</div>
                    </div>
                    <div style="font-weight:700; color:#333;">${parseFloat(i.total_price).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</div>
                </div>`;
        });
        document.getElementById('lista-itens-modal').innerHTML = html;
        document.getElementById('modal-total').innerText = parseFloat(nota.total_amount).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
        document.getElementById('modalDetalhes').style.display = 'flex';
    }

    // --- FUN√á√ÉO DE ENVIAR PARA A CALCULADORA (NOVA) ---
    function enviarParaCalculadora(nome, preco) {
        // Pega o que j√° tem no carrinho ou cria array novo
        let itens = JSON.parse(localStorage.getItem('carrinhoTemp') || '[]');
        
        // Cria o novo item no formato que a calculadora entende
        const novoItem = {
            id: Date.now(),
            nome: nome,
            preco: parseFloat(preco),
            qtd: 1,
            total: parseFloat(preco)
        };
        
        // Salva
        itens.unshift(novoItem);
        localStorage.setItem('carrinhoTemp', JSON.stringify(itens));
        
        // Pergunta se quer ir l√° ver
        if(confirm(`"${nome}" adicionado por R$ ${preco.toFixed(2)}!\n\nDeseja abrir a calculadora agora?`)) {
            window.location.href = 'calculadora.html';
        }
    }

    // --- BUSCA COM RANKING + BOT√ÉO DE ADICIONAR ---
    async function buscar(texto) {
        const area = document.getElementById('area-busca');
        const lista = document.getElementById('lista-compras');

        if(texto.length < 3) { 
            area.style.display='none'; 
            lista.style.display = 'flex'; 
            return; 
        }
        
        lista.style.display = 'none';
        area.style.display = 'flex';
        area.innerHTML = '<div style="padding:20px; color:#888; text-align:center;">üîé Pesquisando pre√ßos...</div>';
        
        const res = await fetch(`https://onde-compensa-api.onrender.com/search?q=${texto}&userId=${userId}`);
        let prods = await res.json();
        
        area.innerHTML = '';
        if(prods.length === 0) {
            area.innerHTML='<div style="padding:30px; color:#666; text-align:center">ü§î Nada encontrado com esse nome.</div>';
            return;
        }

        prods.sort((a, b) => parseFloat(a.unit_price) - parseFloat(b.unit_price));

        prods.forEach((p, index) => {
            const preco = parseFloat(p.unit_price);
            const nomeLoja = p.receipt?.store?.name || p.receipt?.stores?.name || 'Loja Desconhecida';
            const dataCompra = new Date(p.receipt?.issue_date);
            
            const diasAtras = Math.floor((new Date() - dataCompra) / (1000 * 60 * 60 * 24));
            let alertaVelho = "";
            let classePreco = "price-date";
            if(diasAtras > 30) {
                alertaVelho = `<span style="color:#d32f2f; font-weight:bold;">‚ö†Ô∏è Pre√ßo antigo (${diasAtras}d)</span>`;
                classePreco = "old-price";
            } else {
                alertaVelho = `${diasAtras === 0 ? 'Hoje' : diasAtras + ' dias atr√°s'}`;
            }

            let classeRank = '';
            let medalha = '';
            if (index === 0) { classeRank = 'rank-1'; medalha = 'üèÜ'; }
            else if (index === 1) { classeRank = 'rank-2'; medalha = 'ü•à'; }
            else if (index === 2) { classeRank = 'rank-3'; medalha = 'ü•â'; }

            const card = document.createElement('div');
            card.className = `rank-card ${classeRank}`;
            // Aten√ß√£o para as aspas no onclick
            const nomeLimpo = p.raw_name.replace(/"/g, '&quot;').replace(/'/g, "\\'"); 
            
            card.innerHTML = `
                <div class="rank-content" onclick="abrirNotaPorId('${p.receipt_id}')">
                    <div class="rank-badge">${medalha}</div>
                    <div class="rank-info">
                        <h3>${p.raw_name}</h3>
                        <p>${nomeLoja}</p>
                    </div>
                </div>
                <div class="rank-actions">
                    <span class="price-big">${preco.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</span>
                    <span class="${classePreco}">${alertaVelho}</span>
                    
                    <button class="btn-to-calc" onclick="enviarParaCalculadora('${nomeLimpo}', ${preco})">
                        Ôºã üõí
                    </button>
                </div>
            `;
            area.appendChild(card);
        });
    }

    function toggleMenu() { const m = document.getElementById('menuDropdown'); m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; }
    function fecharModal(e) { if(!e || e.target.className.includes('modal') || e.target.tagName==='BUTTON') document.getElementById('modalDetalhes').style.display='none'; }
    async function deletarNota(id) { if(confirm('Deseja apagar esta nota?')) { await fetch(`https://onde-compensa-api.onrender.com/receipts/${id}`, {method:'DELETE'}); carregar(); } }
    async function fazerFaxina() { if(confirm('Limpar notas com erro?')) { await fetch('https://onde-compensa-api.onrender.com/cleanup', {method:'DELETE'}); carregar(); } }
    async function sair() { await supabaseClient.auth.signOut(); window.location.href = 'login.html'; }

    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js'); }); }

    iniciar();
</script>
</body>
</html>