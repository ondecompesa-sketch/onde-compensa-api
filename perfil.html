<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil - OndeCompensa</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f6f8; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .card { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        h1 { color: #333; margin-bottom: 10px; }
        p { color: #666; margin-bottom: 30px; }
        input, select { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1em; background: white; }
        .btn { width: 100%; padding: 15px; background: #007bff; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.1em; margin-top: 20px; transition: 0.2s; }
        .btn:hover { background: #0056b3; }
        .btn-voltar { background: transparent; color: #666; border: 1px solid #ddd; margin-top: 10px; }
        .btn-voltar:hover { background: #eee; }
        .loading { opacity: 0.7; pointer-events: none; }
    </style>
</head>
<body>

<div class="card">
    <h1>üë§ Meu Perfil</h1>
    <p>Localiza√ß√£o exata para ofertas exatas.</p>

    <input type="text" id="nome" placeholder="Seu Nome Completo">
    
    <select id="cidade" onchange="atualizarBairros()">
        <option value="" disabled selected>Selecione sua Cidade</option>
        </select>
    
    <select id="bairro" disabled>
        <option value="" disabled selected>Selecione a Cidade primeiro</option>
    </select>

    <button onclick="salvarPerfil()" id="btn-salvar" class="btn">Salvar Altera√ß√µes</button>
    <button onclick="voltar()" class="btn btn-voltar">Voltar</button>
</div>

<script>
    // --- ‚ö†Ô∏è SUAS CHAVES DO SUPABASE (PREENCHA AQUI) ---
    const SUPABASE_URL = 'https://sjhvftndaplufqnrjxcs.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqaHZmdG5kYXBsdWZxbnJqeGNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MDYxMDgsImV4cCI6MjA4MzM4MjEwOH0.bNstvXQ7m2Zt-0UatKmdkxM95-Ft4SRBc1JGGITSnzk';
    // -----------------------------------------------

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // üó∫Ô∏è BASE DE DADOS DE LOCAIS (RIO E GRANDE RIO)
    const locais = {
        "Rio de Janeiro": [
            "Aboli√ß√£o", "Acari", "√Ågua Santa", "Alto da Boa Vista", "Anchieta", "Andara√≠", "Anil", "Bangu", "Barra da Tijuca", "Barra de Guaratiba", "Barros Filho", "Benfica", "Bento Ribeiro", "Bonsucesso", "Botafogo", "Br√°s de Pina", "Cachambi", "Caju", "Camorim", "Campinho", "Campo Grande", "Cascadura", "Catete", "Catumbi", "Cavalcanti", "Centro", "Cidade de Deus", "Cidade Nova", "Cidade Universit√°ria", "Cocot√°", "Coelho Neto", "Col√©gio", "Complexo do Alem√£o", "Copacabana", "Cordovil", "Cosme Velho", "Cosmos", "Costa Barros", "Curicica", "Del Castilho", "Deodoro", "Encantado", "Engenheiro Leal", "Engenho da Rainha", "Engenho de Dentro", "Engenho Novo", "Est√°cio", "Flamengo", "Gamboa", "Gard√™nia Azul", "G√°vea", "Gericin√≥", "Gl√≥ria", "Graja√∫", "Guadalupe", "Guaratiba", "Higien√≥polis", "Hon√≥rio Gurgel", "Humait√°", "Inha√∫ma", "Inhoa√≠ba", "Ipanema", "Iraj√°", "Itanhang√°", "Jacarepagu√°", "Jacar√©", "Jardim Am√©rica", "Jardim Bot√¢nico", "Jardim Carioca", "Jardim Guanabara", "Jardim Sulacap", "Jo√°", "Lagoa", "Laranjeiras", "Leblon", "Leme", "Madureira", "Manguinhos", "Maracan√£", "Marechal Hermes", "Maria da Gra√ßa", "M√©ier", "Moner√≥", "Olaria", "Oswaldo Cruz", "Paci√™ncia", "Padre Miguel", "Paquet√°", "Parada de Lucas", "Parque Anchieta", "Parque Col√∫mbia", "Pavuna", "Pechincha", "Pedra de Guaratiba", "Penha", "Penha Circular", "Piedade", "Pilares", "Pitangueiras", "Portuguesa", "Pra√ßa da Bandeira", "Pra√ßa Seca", "Quintino Bocai√∫va", "Ramos", "Recreio dos Bandeirantes", "Riachuelo", "Ribeira", "Ricardo de Albuquerque", "Rio Comprido", "Rocha", "Rocha Miranda", "Rocinha", "Sampaio", "Santa Cruz", "Santa Teresa", "Sant√≠ssimo", "Santo Cristo", "S√£o Conrado", "S√£o Crist√≥v√£o", "S√£o Francisco Xavier", "Sa√∫de", "Senador Camar√°", "Senador Vasconcelos", "Sepetiba", "Tanque", "Taquara", "Tau√°", "Tijuca", "Todos os Santos", "Tom√°s Coelho", "Turia√ßu", "Urca", "Vargem Grande", "Vargem Pequena", "Vasco da Gama", "Vaz Lobo", "Vicente de Carvalho", "Vidigal", "Vig√°rio Geral", "Vila da Penha", "Vila Isabel", "Vila Kosmos", "Vila Militar", "Vila Valqueire", "Vista Alegre", "Zumbi"
        ],
        "Niter√≥i": [
            "Badu", "Barreto", "Boa Viagem", "Cachoeiras", "Cafub√°", "Camboinhas", "Cantagalo", "Caramujo", "Centro", "Charitas", "Cubango", "Engenhoca", "Fonseca", "Icara√≠", "Ilha da Concei√ß√£o", "Ing√°", "Itacoatiara", "Itaipu", "Jurujuba", "Largo da Batalha", "Macei√≥", "Maria Paula", "Matapaca", "Muriqui", "Piratininga", "Ponta d'Areia", "Rio do Ouro", "Santa B√°rbara", "Santa Rosa", "Santana", "S√£o Domingos", "S√£o Francisco", "S√£o Louren√ßo", "Tenente Jardim", "V√°rzea das Mo√ßas", "Vi√ßoso Jardim", "Vital Brasil"
        ],
        "Nova Igua√ßu": [
            "Austin", "Cabu√ßu", "Caioaba", "Calif√≥rnia", "Carmary", "Centro", "Cer√¢mica", "Comendador Soares", "Danon", "Engenho Pequeno", "Geneciano", "Igua√ßu Velho", "Jardim Igua√ßu", "Kennedy", "K-11", "Km 32", "Lagoinha", "Marapicu", "Miguel Couto", "Montevid√©u", "Nova Am√©rica", "Ouro Verde", "Palhada", "Posse", "Prata", "Rancho Novo", "Riach√£o", "Santa Eug√™nia", "Santa Rita", "Tingu√°", "Vila de Cava", "Vila Nova"
        ],
        "Duque de Caxias": [
            "25 de Agosto", "Campos El√≠seos", "Centen√°rio", "Centro", "Ch√°cara Rio-Petr√≥polis", "Cidade dos Meninos", "Doutor Laureano", "Figueira", "Imbari√™", "Jardim Gramacho", "Jardim Leal", "Jardim Primavera", "Olavo Bilac", "Parada Ang√©lica", "Parque Duque", "Parque Equitativa", "Parque Fluminense", "Periquitos", "Pilar", "Santa Cruz da Serra", "Santo Ant√¥nio", "Saracuruna", "Taquara", "Vila Maria Helena", "Vila Ros√°rio", "Vila S√£o Lu√≠s", "Xer√©m"
        ],
        "S√£o Gon√ßalo": [
            "Alc√¢ntara", "Amendoeira", "Antonina", "Arsenal", "Barrac√£o", "Boa Vista", "Boa√ßu", "Brasil√¢ndia", "Centro", "Coluband√™", "Engenho Pequeno", "Fazenda dos Mineiros", "Galo Branco", "Guaxindiba", "Ita√≥ca", "Ita√∫na", "Jardim Catarina", "Lagoinha", "Laranjal", "Largo da Ideia", "Maria Paula", "Monjolos", "Mutondo", "Neves", "Nova Cidade", "Pacheco", "Parada 40", "Para√≠so", "Patronato", "Porto da Pedra", "Porto do Rosa", "Porto Novo", "Porto Velho", "Raul Veiga", "Rio do Ouro", "Rocha", "Sacramento", "Santa Catarina", "Santa Isabel", "Santa Luzia", "Trindade", "Vila Lage", "Vila Tr√™s", "Z√© Garoto"
        ],
        "S√£o Jo√£o de Meriti": [
            "Agostinho Porto", "Centro", "Coelho da Rocha", "√âden", "Engenheiro Belford", "Grande Rio", "Jardim Meriti", "Jardim Metr√≥pole", "Parque Alian", "Parque Anal√¢ndia", "Parque Araruama", "S√£o Mateus", "Tomazinho", "Venda Velha", "Vila Rosali", "Vilar dos Teles"
        ],
        "Belford Roxo": [
            "Areia Branca", "Centro", "Heli√≥polis", "Itaipu", "Jardim Redentor", "Lote XV", "Nova Aurora", "Parque Amorim", "Parque dos Ferreiros", "Parque S√£o Vicente", "Piam", "Santa Am√©lia", "Santa Maria", "S√£o Bernardo", "Shangri-l√°", "Vila Dagmar", "Wona"
        ]
    };

    // 1. Preenche o Select de Cidades ao iniciar
    function popularCidades() {
        const selectCidade = document.getElementById('cidade');
        const cidadesOrdenadas = Object.keys(locais).sort();
        
        cidadesOrdenadas.forEach(cidade => {
            const option = document.createElement('option');
            option.value = cidade;
            option.innerText = cidade;
            selectCidade.appendChild(option);
        });
    }

    // 2. Atualiza a lista de bairros quando troca a cidade
    function atualizarBairros() {
        const cidadeSelecionada = document.getElementById('cidade').value;
        const selectBairro = document.getElementById('bairro');
        
        // Limpa bairros anteriores
        selectBairro.innerHTML = '<option value="" disabled selected>Selecione seu Bairro</option>';
        
        if (cidadeSelecionada && locais[cidadeSelecionada]) {
            selectBairro.disabled = false;
            locais[cidadeSelecionada].sort().forEach(bairro => {
                const option = document.createElement('option');
                option.value = bairro;
                option.innerText = bairro;
                selectBairro.appendChild(option);
            });
        } else {
            selectBairro.disabled = true;
        }
    }

    // 3. Carregar dados do usu√°rio (Se j√° tiver cadastro)
    async function carregarDados() {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return window.location.href = 'login.html';

        const { data: perfil } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', user.id)
            .single();

        if (perfil) {
            if(perfil.full_name) document.getElementById('nome').value = perfil.full_name;
            
            // L√≥gica para selecionar Cidade e Bairro salvos
            if(perfil.cidade) {
                document.getElementById('cidade').value = perfil.cidade;
                atualizarBairros(); // For√ßa atualiza√ß√£o dos bairros
                
                // Pequeno delay para garantir que o select de bairros preencheu
                setTimeout(() => {
                    if(perfil.bairro) document.getElementById('bairro').value = perfil.bairro;
                }, 50);
            }
        }
    }

    // 4. Salvar no Banco
    async function salvarPerfil() {
        const btn = document.getElementById('btn-salvar');
        const nome = document.getElementById('nome').value;
        const cidade = document.getElementById('cidade').value;
        const bairro = document.getElementById('bairro').value;

        if (!nome || !cidade || !bairro) return alert("Por favor, preencha tudo!");

        btn.innerText = "Salvando...";
        btn.classList.add("loading");

        const { data: { user } } = await supabase.auth.getUser();

        const { error } = await supabase.from('profiles').upsert({
            id: user.id,
            email: user.email,
            full_name: nome,
            cidade: cidade, // Agora salvamos a cidade tamb√©m!
            bairro: bairro,
            updated_at: new Date()
        });

        if (error) {
            alert("Erro: " + error.message);
            btn.innerText = "Salvar Altera√ß√µes";
            btn.classList.remove("loading");
        } else {
            alert("Perfil atualizado! ‚úÖ");
            window.location.href = 'historico.html';
        }
    }

    function voltar() { window.location.href = 'historico.html'; }

    // Inicia tudo
    popularCidades();
    carregarDados();
</script>

</body>
</html>