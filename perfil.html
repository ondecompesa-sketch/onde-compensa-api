<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil - OndeCompensa</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f6f8; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .card { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        h1 { color: #333; margin-bottom: 10px; }
        p { color: #666; margin-bottom: 30px; }
        input, select { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1em; background: white; }
        .btn { width: 100%; padding: 15px; background: #007bff; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.1em; margin-top: 20px; transition: 0.2s; }
        .btn:hover { background: #0056b3; }
        .btn-voltar { background: transparent; color: #666; border: 1px solid #ddd; margin-top: 10px; }
        .btn-voltar:hover { background: #eee; }
        .loading { opacity: 0.7; pointer-events: none; }
    </style>
</head>
<body>

<div class="card">
    <h1>ðŸ‘¤ Meu Perfil</h1>
    <p>LocalizaÃ§Ã£o exata para ofertas exatas.</p>

    <input type="text" id="nome" placeholder="Seu Nome Completo">
    
    <select id="cidade" onchange="atualizarBairros()">
        <option value="" disabled selected>Selecione sua Cidade</option>
    </select>
    
    <select id="bairro" disabled>
        <option value="" disabled selected>Selecione a Cidade primeiro</option>
    </select>

    <button onclick="salvarPerfil()" id="btn-salvar" class="btn">Salvar AlteraÃ§Ãµes</button>
    <button onclick="voltar()" class="btn btn-voltar">Voltar</button>
</div>

<script>
    // --- âš ï¸ SUAS CHAVES DO SUPABASE (PREENCHA AQUI) ---
    const SUPABASE_URL = 'https://sjhvftndaplufqnrjxcs.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqaHZmdG5kYXBsdWZxbnJqeGNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MDYxMDgsImV4cCI6MjA4MzM4MjEwOH0.bNstvXQ7m2Zt-0UatKmdkxM95-Ft4SRBc1JGGITSnzk';
    // -----------------------------------------------

    // MUDANÃ‡A AQUI: supabaseClient
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ðŸ—ºï¸ BASE DE DADOS DE LOCAIS (RIO E GRANDE RIO)
    const locais = {
        "Rio de Janeiro": [
            "AboliÃ§Ã£o", "Acari", "Ãgua Santa", "Alto da Boa Vista", "Anchieta", "AndaraÃ­", "Anil", "Bangu", "Barra da Tijuca", "Barra de Guaratiba", "Barros Filho", "Benfica", "Bento Ribeiro", "Bonsucesso", "Botafogo", "BrÃ¡s de Pina", "Cachambi", "Caju", "Camorim", "Campinho", "Campo Grande", "Cascadura", "Catete", "Catumbi", "Cavalcanti", "Centro", "Cidade de Deus", "Cidade Nova", "Cidade UniversitÃ¡ria", "CocotÃ¡", "Coelho Neto", "ColÃ©gio", "Complexo do AlemÃ£o", "Copacabana", "Cordovil", "Cosme Velho", "Cosmos", "Costa Barros", "Curicica", "Del Castilho", "Deodoro", "Encantado", "Engenheiro Leal", "Engenho da Rainha", "Engenho de Dentro", "Engenho Novo", "EstÃ¡cio", "Flamengo", "Gamboa", "GardÃªnia Azul", "GÃ¡vea", "GericinÃ³", "GlÃ³ria", "GrajaÃº", "Guadalupe", "Guaratiba", "HigienÃ³polis", "HonÃ³rio Gurgel", "HumaitÃ¡", "InhaÃºma", "InhoaÃ­ba", "Ipanema", "IrajÃ¡", "ItanhangÃ¡", "JacarepaguÃ¡", "JacarÃ©", "Jardim AmÃ©rica", "Jardim BotÃ¢nico", "Jardim Carioca", "Jardim Guanabara", "Jardim Sulacap", "JoÃ¡", "Lagoa", "Laranjeiras", "Leblon", "Leme", "Madureira", "Manguinhos", "MaracanÃ£", "Marechal Hermes", "Maria da GraÃ§a", "MÃ©ier", "MonerÃ³", "Olaria", "Oswaldo Cruz", "PaciÃªncia", "Padre Miguel", "PaquetÃ¡", "Parada de Lucas", "Parque Anchieta", "Parque ColÃºmbia", "Pavuna", "Pechincha", "Pedra de Guaratiba", "Penha", "Penha Circular", "Piedade", "Pilares", "Pitangueiras", "Portuguesa", "PraÃ§a da Bandeira", "PraÃ§a Seca", "Quintino BocaiÃºva", "Ramos", "Recreio dos Bandeirantes", "Riachuelo", "Ribeira", "Ricardo de Albuquerque", "Rio Comprido", "Rocha", "Rocha Miranda", "Rocinha", "Sampaio", "Santa Cruz", "Santa Teresa", "SantÃ­ssimo", "Santo Cristo", "SÃ£o Conrado", "SÃ£o CristÃ³vÃ£o", "SÃ£o Francisco Xavier", "SaÃºde", "Senador CamarÃ¡", "Senador Vasconcelos", "Sepetiba", "Tanque", "Taquara", "TauÃ¡", "Tijuca", "Todos os Santos", "TomÃ¡s Coelho", "TuriaÃ§u", "Urca", "Vargem Grande", "Vargem Pequena", "Vasco da Gama", "Vaz Lobo", "Vicente de Carvalho", "Vidigal", "VigÃ¡rio Geral", "Vila da Penha", "Vila Isabel", "Vila Kosmos", "Vila Militar", "Vila Valqueire", "Vista Alegre", "Zumbi"
        ],
        "NiterÃ³i": [
            "Badu", "Barreto", "Boa Viagem", "Cachoeiras", "CafubÃ¡", "Camboinhas", "Cantagalo", "Caramujo", "Centro", "Charitas", "Cubango", "Engenhoca", "Fonseca", "IcaraÃ­", "Ilha da ConceiÃ§Ã£o", "IngÃ¡", "Itacoatiara", "Itaipu", "Jurujuba", "Largo da Batalha", "MaceiÃ³", "Maria Paula", "Matapaca", "Muriqui", "Piratininga", "Ponta d'Areia", "Rio do Ouro", "Santa BÃ¡rbara", "Santa Rosa", "Santana", "SÃ£o Domingos", "SÃ£o Francisco", "SÃ£o LourenÃ§o", "Tenente Jardim", "VÃ¡rzea das MoÃ§as", "ViÃ§oso Jardim", "Vital Brasil"
        ],
        "Nova IguaÃ§u": [
            "Austin", "CabuÃ§u", "Caioaba", "CalifÃ³rnia", "Carmary", "Centro", "CerÃ¢mica", "Comendador Soares", "Danon", "Engenho Pequeno", "Geneciano", "IguaÃ§u Velho", "Jardim IguaÃ§u", "Kennedy", "K-11", "Km 32", "Lagoinha", "Marapicu", "Miguel Couto", "MontevidÃ©u", "Nova AmÃ©rica", "Ouro Verde", "Palhada", "Posse", "Prata", "Rancho Novo", "RiachÃ£o", "Santa EugÃªnia", "Santa Rita", "TinguÃ¡", "Vila de Cava", "Vila Nova"
        ],
        "Duque de Caxias": [
            "25 de Agosto", "Campos ElÃ­seos", "CentenÃ¡rio", "Centro", "ChÃ¡cara Rio-PetrÃ³polis", "Cidade dos Meninos", "Doutor Laureano", "Figueira", "ImbariÃª", "Jardim Gramacho", "Jardim Leal", "Jardim Primavera", "Olavo Bilac", "Parada AngÃ©lica", "Parque Duque", "Parque Equitativa", "Parque Fluminense", "Periquitos", "Pilar", "Santa Cruz da Serra", "Santo AntÃ´nio", "Saracuruna", "Taquara", "Vila Maria Helena", "Vila RosÃ¡rio", "Vila SÃ£o LuÃ­s", "XerÃ©m"
        ],
        "SÃ£o GonÃ§alo": [
            "AlcÃ¢ntara", "Amendoeira", "Antonina", "Arsenal", "BarracÃ£o", "Boa Vista", "BoaÃ§u", "BrasilÃ¢ndia", "Centro", "ColubandÃª", "Engenho Pequeno", "Fazenda dos Mineiros", "Galo Branco", "Guaxindiba", "ItaÃ³ca", "ItaÃºna", "Jardim Catarina", "Lagoinha", "Laranjal", "Largo da Ideia", "Maria Paula", "Monjolos", "Mutondo", "Neves", "Nova Cidade", "Pacheco", "Parada 40", "ParaÃ­so", "Patronato", "Porto da Pedra", "Porto do Rosa", "Porto Novo", "Porto Velho", "Raul Veiga", "Rio do Ouro", "Rocha", "Sacramento", "Santa Catarina", "Santa Isabel", "Santa Luzia", "Trindade", "Vila Lage", "Vila TrÃªs", "ZÃ© Garoto"
        ],
        "SÃ£o JoÃ£o de Meriti": [
            "Agostinho Porto", "Centro", "Coelho da Rocha", "Ã‰den", "Engenheiro Belford", "Grande Rio", "Jardim Meriti", "Jardim MetrÃ³pole", "Parque Alian", "Parque AnalÃ¢ndia", "Parque Araruama", "SÃ£o Mateus", "Tomazinho", "Venda Velha", "Vila Rosali", "Vilar dos Teles"
        ],
        "Belford Roxo": [
            "Areia Branca", "Centro", "HeliÃ³polis", "Itaipu", "Jardim Redentor", "Lote XV", "Nova Aurora", "Parque Amorim", "Parque dos Ferreiros", "Parque SÃ£o Vicente", "Piam", "Santa AmÃ©lia", "Santa Maria", "SÃ£o Bernardo", "Shangri-lÃ¡", "Vila Dagmar", "Wona"
        ]
    };

    // 1. Preenche o Select de Cidades ao iniciar
    function popularCidades() {
        const selectCidade = document.getElementById('cidade');
        const cidadesOrdenadas = Object.keys(locais).sort();
        
        cidadesOrdenadas.forEach(cidade => {
            const option = document.createElement('option');
            option.value = cidade;
            option.innerText = cidade;
            selectCidade.appendChild(option);
        });
    }

    // 2. Atualiza a lista de bairros quando troca a cidade
    function atualizarBairros() {
        const cidadeSelecionada = document.getElementById('cidade').value;
        const selectBairro = document.getElementById('bairro');
        
        // Limpa bairros anteriores
        selectBairro.innerHTML = '<option value="" disabled selected>Selecione seu Bairro</option>';
        
        if (cidadeSelecionada && locais[cidadeSelecionada]) {
            selectBairro.disabled = false;
            locais[cidadeSelecionada].sort().forEach(bairro => {
                const option = document.createElement('option');
                option.value = bairro;
                option.innerText = bairro;
                selectBairro.appendChild(option);
            });
        } else {
            selectBairro.disabled = true;
        }
    }

    // 3. Carregar dados do usuÃ¡rio (Se jÃ¡ tiver cadastro)
    async function carregarDados() {
        // MUDANÃ‡A AQUI: supabaseClient
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return window.location.href = 'login.html';

        const { data: perfil } = await supabaseClient
            .from('profiles')
            .select('*')
            .eq('id', user.id)
            .single();

        if (perfil) {
            if(perfil.full_name) document.getElementById('nome').value = perfil.full_name;
            
            if(perfil.cidade) {
                document.getElementById('cidade').value = perfil.cidade;
                atualizarBairros();
                
                setTimeout(() => {
                    if(perfil.bairro) document.getElementById('bairro').value = perfil.bairro;
                }, 50);
            }
        }
    }

    // 4. Salvar no Banco
    async function salvarPerfil() {
        const btn = document.getElementById('btn-salvar');
        const nome = document.getElementById('nome').value;
        const cidade = document.getElementById('cidade').value;
        const bairro = document.getElementById('bairro').value;

        if (!nome || !cidade || !bairro) return alert("Por favor, preencha tudo!");

        btn.innerText = "Salvando...";
        btn.classList.add("loading");

        const { data: { user } } = await supabaseClient.auth.getUser();

        const { error } = await supabaseClient.from('profiles').upsert({
            id: user.id,
            email: user.email,
            full_name: nome,
            cidade: cidade, 
            bairro: bairro,
            updated_at: new Date()
        });

        if (error) {
            alert("Erro: " + error.message);
            btn.innerText = "Salvar AlteraÃ§Ãµes";
            btn.classList.remove("loading");
        } else {
            alert("Perfil atualizado! âœ…");
            window.location.href = 'historico.html';
        }
    }

    function voltar() { window.location.href = 'historico.html'; }

    // Inicia tudo
    popularCidades();
    carregarDados();
</script>

</body>
</html>