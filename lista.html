<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2e7d32">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Lista Inteligente üõí</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background: #f4f7fa; padding: 20px; padding-bottom: 90px; color: #333; }
        .container { max-width: 600px; margin: 0 auto; }
        
        h1 { color: #2e7d32; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; margin-top: 0; }
        
        .input-group { display: flex; gap: 10px; background: white; padding: 10px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        input { border: none; outline: none; font-size: 1rem; flex: 1; padding: 5px; }
        .btn-add { background: #2e7d32; color: white; border: none; width: 40px; height: 40px; border-radius: 8px; font-size: 1.2rem; cursor: pointer; }
        
        .list-container { display: flex; flex-direction: column; gap: 10px; }
        .list-item { background: white; padding: 15px; border-radius: 12px; display: flex; flex-direction: column; gap: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); position: relative; border-left: 5px solid #ccc; transition: 0.3s; }
        
        .item-row { display: flex; justify-content: space-between; align-items: center; }
        .item-name { font-weight: 600; font-size: 1.1rem; }
        .btn-del { color: #ef5350; background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 5px; }

        /* Resultado da An√°lise */
        .best-price-badge { 
            background: #e8f5e9; color: #1b5e20; padding: 8px; border-radius: 8px; 
            font-size: 0.85rem; margin-top: 8px; display: none; border: 1px solid #c8e6c9;
        }
        .loading .best-price-badge { display: block; background: #fff3e0; color: #e65100; border-color: #ffe0b2; }
        .found .best-price-badge { display: block; }
        .not-found .best-price-badge { display: block; background: #eceff1; color: #607d8b; border-color: #cfd8dc; }

        .btn-analyze { 
            position: fixed; bottom: 25px; left: 20px; right: 20px; 
            background: #007bff; color: white; padding: 16px; 
            border-radius: 15px; font-weight: bold; font-size: 1.1rem; 
            border: none; box-shadow: 0 4px 15px rgba(0,123,255,0.3); 
            cursor: pointer; z-index: 100; display: flex; justify-content: center; gap: 10px;
        }
        
        .fab-back { position: fixed; top: 20px; right: 20px; background: white; color: #333; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-decoration: none; font-weight: bold; z-index: 200; }
    </style>
</head>
<body>

<a href="index.html" class="fab-back">‚úï</a>

<div class="container">
    <h1>üìù Lista de Compras</h1>
    <p style="color:#666; font-size:0.9rem; margin-bottom:20px;">Adicione itens e clique em "Onde Comprar" para ver o menor pre√ßo na sua regi√£o.</p>

    <div class="input-group">
        <input type="text" id="inp-item" placeholder="Ex: Arroz, Detergente..." onkeypress="if(event.key==='Enter') adicionar()">
        <button class="btn-add" onclick="adicionar()">Ôºã</button>
    </div>

    <div id="lista" class="list-container">
        </div>
</div>

<button class="btn-analyze" onclick="analisarPrecos()">
    <span>üîç</span> Ver Onde Comprar
</button>

<script>
    const SUPABASE_URL = 'https://sjhvftndaplufqnrjxcs.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqaHZmdG5kYXBsdWZxbnJqeGNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MDYxMDgsImV4cCI6MjA4MzM4MjEwOH0.bNstvXQ7m2Zt-0UatKmdkxM95-Ft4SRBc1JGGITSnzk';
    const cliente = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let listaItems = JSON.parse(localStorage.getItem('minhaLista') || '[]');
    const minhaCidade = localStorage.getItem('minhaCidade') || '';

    function renderizar() {
        const div = document.getElementById('lista');
        div.innerHTML = '';
        
        if(listaItems.length === 0) {
            div.innerHTML = '<div style="text-align:center; padding:30px; color:#999;">Sua lista est√° vazia.</div>';
            return;
        }

        listaItems.forEach((item, index) => {
            const el = document.createElement('div');
            el.className = `list-item ${item.status || ''}`;
            el.id = `item-${index}`;
            el.innerHTML = `
                <div class="item-row">
                    <span class="item-name">${item.nome}</span>
                    <button class="btn-del" onclick="remover(${index})">üóëÔ∏è</button>
                </div>
                <div class="best-price-badge" id="badge-${index}">
                    ${item.resultado || 'Aguardando an√°lise...'}
                </div>
            `;
            div.appendChild(el);
        });
    }

    function adicionar() {
        const inp = document.getElementById('inp-item');
        const nome = inp.value.trim();
        if(!nome) return;
        
        listaItems.push({ nome, status: '', resultado: '' });
        salvar(); renderizar();
        inp.value = ''; inp.focus();
    }

    function remover(i) {
        listaItems.splice(i, 1);
        salvar(); renderizar();
    }

    function salvar() { localStorage.setItem('minhaLista', JSON.stringify(listaItems)); }

    // --- C√âREBRO DA OPERA√á√ÉO üß† ---
    async function analisarPrecos() {
        const btn = document.querySelector('.btn-analyze');
        btn.innerHTML = '‚è≥ Pesquisando...'; btn.disabled = true;

        for (let i = 0; i < listaItems.length; i++) {
            const item = listaItems[i];
            const badge = document.getElementById(`badge-${i}`);
            const card = document.getElementById(`item-${i}`);
            
            card.classList.remove('found', 'not-found');
            card.classList.add('loading');
            badge.innerText = 'Pesquisando pre√ßos...';

            try {
                // 1. Busca produtos parecidos no banco (Usa a fun√ß√£o RPC que ignora acentos)
                // Se der erro no RPC, usa fallback simples
                let { data } = await cliente.rpc('buscar_produtos', { termo: item.nome })
                    .select(`
                        unit_price, valid_until,
                        receipt:receipts ( store:stores ( name, city ) )
                    `)
                    .limit(20); // Pega os 20 melhores matches

                if (!data) data = [];

                // 2. Filtra pela cidade (se tiver definida) e ordena por pre√ßo
                let ofertas = data.filter(d => {
                    if(!d.receipt?.store) return false;
                    const cidadeLoja = d.receipt.store.city || '';
                    
                    // L√≥gica de Chave Mestra (RJ, Todas, etc)
                    const chavesMestras = ['rj', 'estado do rio', 'todas', 'brasil', 'rio de janeiro'];
                    const cLoja = cidadeLoja.toLowerCase();
                    const cMinha = minhaCidade.toLowerCase();

                    // Se n√£o tenho cidade, aceita tudo. Se tenho, filtra.
                    if(!minhaCidade) return true;
                    if(chavesMestras.some(k => cLoja.includes(k))) return true;
                    return cLoja.includes(cMinha);
                });

                // Ordena: Menor pre√ßo primeiro
                ofertas.sort((a, b) => a.unit_price - b.unit_price);

                card.classList.remove('loading');
                
                if (ofertas.length > 0) {
                    const melhor = ofertas[0];
                    const nomeLoja = melhor.receipt.store.name;
                    const preco = parseFloat(melhor.unit_price).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                    
                    // Verifica se √© oferta v√°lida (encarte)
                    const hoje = new Date().toISOString().split('T')[0];
                    let icone = 'üí∞';
                    if (melhor.valid_until && melhor.valid_until >= hoje) icone = 'üî• Oferta';

                    item.resultado = `${icone}: <b>${preco}</b> no <b>${nomeLoja}</b>`;
                    item.status = 'found';
                } else {
                    item.resultado = `Nenhum pre√ßo recente encontrado para sua cidade.`;
                    item.status = 'not-found';
                }

            } catch (e) {
                console.error(e);
                item.resultado = "Erro na busca.";
            }

            // Atualiza visualmente um por um (efeito legal)
            renderizar(); 
        }

        salvar();
        btn.innerHTML = '<span>üîç</span> Atualizar Pre√ßos'; btn.disabled = false;
    }

    renderizar();
</script>
</body>
</html>