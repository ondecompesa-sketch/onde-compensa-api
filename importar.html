<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Importar Ofertas (IA) ü§ñ</title>
    <script src="[https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2](https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2)"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 20px; background: #f4f4f9; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #2e7d32; display: flex; align-items: center; gap: 10px; margin-top: 0; }
        
        textarea { 
            width: 100%; height: 350px; padding: 15px; 
            border-radius: 10px; border: 2px solid #eee; 
            font-family: monospace; font-size: 0.85rem; 
            background: #fafafa; resize: vertical;
        }
        textarea:focus { border-color: #2e7d32; outline: none; background: white; }
        
        button { 
            background: #2e7d32; color: white; padding: 15px; 
            border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; 
            cursor: pointer; width: 100%; margin-top: 15px; 
            transition: transform 0.1s, background 0.2s;
        }
        button:hover { background: #1b5e20; }
        button:active { transform: scale(0.98); }
        
        #status { margin-top: 20px; padding: 15px; border-radius: 8px; font-weight: 500; display: none; line-height: 1.6; }
        .sucesso { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .erro { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        
        .hint { background: #e3f2fd; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 0.9rem; color: #0d47a1; border: 1px solid #bbdefb; }
    </style>
</head>
<body>

<div class="container">
    <h2>ü§ñ Importador Blindado</h2>
    
    <div class="hint">
        üí° <b>Dica:</b> O sistema agora aceita listas (`[...]`) e corrige pequenas falhas no JSON do Gemini. Pode colar sem medo!
    </div>

    <textarea id="jsonInput" placeholder='Cole o JSON do Gemini aqui...'></textarea>
    
    <button onclick="importar()">üöÄ Processar e Salvar</button>
    <div id="status"></div>
    <div style="text-align:center; margin-top:20px;">
        <a href="index.html" style="color:#666; text-decoration:none;">‚Üê Voltar para Dashboard</a>
    </div>
</div>

<script>
    const SUPABASE_URL = '[https://sjhvftndaplufqnrjxcs.supabase.co](https://sjhvftndaplufqnrjxcs.supabase.co)';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqaHZmdG5kYXBsdWZxbnJqeGNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MDYxMDgsImV4cCI6MjA4MzM4MjEwOH0.bNstvXQ7m2Zt-0UatKmdkxM95-Ft4SRBc1JGGITSnzk';
    
    const clienteSupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    function mostrarStatus(html, tipo) {
        const div = document.getElementById('status');
        div.style.display = 'block';
        div.className = tipo === 'erro' ? 'erro' : 'sucesso';
        div.innerHTML = html;
    }

    async function importar() {
        const inputRaw = document.getElementById('jsonInput').value;
        if(!inputRaw.trim()) return alert("Cole o JSON primeiro!");

        try {
            mostrarStatus("‚è≥ Analisando e corrigindo JSON...", "sucesso");
            
            // 1. LIMPEZA DO JSON (Remove markdown e espa√ßos extras)
            let jsonLimpo = inputRaw
                .replace(/```json/g, '')
                .replace(/```/g, '')
                .trim();

            // 2. PARSE SEGURO
            let dados;
            try {
                dados = JSON.parse(jsonLimpo);
            } catch (e) {
                // Tenta remover v√≠rgulas tra√ßoeiras (ex: "preco": 10, } -> "preco": 10 })
                jsonLimpo = jsonLimpo.replace(/,\s*}/g, '}').replace(/,\s*]/g, ']');
                dados = JSON.parse(jsonLimpo); // Tenta de novo
            }

            // 3. NORMALIZA√á√ÉO (Transforma tudo em Array)
            // Se o Gemini mandou um objeto s√≥, transforma em lista [objeto]
            // Se mandou lista, usa a lista.
            const listaOfertas = Array.isArray(dados) ? dados : [dados];
            
            const { data: { session } } = await clienteSupabase.auth.getSession();
            if(!session) return mostrarStatus("‚ùå Fa√ßa login!", "erro");
            const userId = session.user.id;

            let relatorio = `<b>Processando ${listaOfertas.length} encarte(s):</b><br>`;

            // 4. LOOP PRINCIPAL (Processa cada oferta da lista)
            for (const oferta of listaOfertas) {
                
                // Normaliza cidades daquela oferta
                let listaCidades = [];
                if (Array.isArray(oferta.cidades)) listaCidades = oferta.cidades;
                else if (oferta.cidade) listaCidades = [oferta.cidade];
                else listaCidades = ['Local n√£o informado'];

                relatorio += `<hr style="opacity:0.3">üõí <b>${oferta.loja}</b>:<br>`;

                for (const nomeCidade of listaCidades) {
                    // Busca ou Cria Loja
                    let { data: loja } = await clienteSupabase
                        .from('stores')
                        .select('id')
                        .ilike('name', oferta.loja)
                        .ilike('city', nomeCidade)
                        .maybeSingle();

                    let lojaId;
                    if (loja) {
                        lojaId = loja.id;
                        // Verifica Duplicidade Hoje
                        const hoje = new Date().toISOString().split('T')[0];
                        const { data: duplicata } = await clienteSupabase
                            .from('receipts')
                            .select('id')
                            .eq('store_id', lojaId)
                            .eq('total_amount', 0)
                            .gte('issue_date', hoje)
                            .maybeSingle();

                        if (duplicata) {
                            relatorio += `‚ö†Ô∏è <b>${nomeCidade}</b>: J√° existe hoje (Pulado).<br>`;
                            continue; 
                        }
                    } else {
                        const { data: novaLoja, error: errLoja } = await clienteSupabase
                            .from('stores')
                            .insert({ name: oferta.loja, city: nomeCidade })
                            .select().single();
                        if(errLoja) throw errLoja;
                        lojaId = novaLoja.id;
                    }

                    // Cria Nota
                    const { data: nota, error: errNota } = await clienteSupabase.from('receipts').insert({
                        user_id: userId, store_id: lojaId, total_amount: 0, issue_date: new Date().toISOString()
                    }).select().single();
                    if(errNota) throw errNota;

                    // Salva Itens
                    const itensParaSalvar = oferta.itens.map(item => ({
                        receipt_id: nota.id,
                        raw_name: item.nome,
                        unit_price: parseFloat(item.preco), 
                        total_price: parseFloat(item.preco),
                        quantity: 1,
                        valid_until: oferta.validade || null,
                        tags: item.tags || ''
                    }));

                    const { error: errItens } = await clienteSupabase.from('receipt_items').insert(itensParaSalvar);
                    if(errItens) throw errItens;

                    relatorio += `‚úÖ <b>${nomeCidade}</b>: Sucesso (${oferta.itens.length} itens)<br>`;
                }
            }

            mostrarStatus(`${relatorio}<br>üèÅ <b>Processo Finalizado!</b>`, "sucesso");
            document.getElementById('jsonInput').value = '';

        } catch (e) {
            console.error(e);
            mostrarStatus(`‚ùå Erro de JSON cr√≠tico: Verifique se n√£o faltam chaves "}" ou colchetes "]".<br><small>${e.message}</small>`, "erro");
        }
    }
</script>
</body>
</html>