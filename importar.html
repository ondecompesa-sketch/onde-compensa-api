<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Importar Ofertas (IA) ü§ñ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 20px; background: #f4f4f9; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #2e7d32; display: flex; align-items: center; gap: 10px; margin-top: 0; }
        
        textarea { 
            width: 100%; height: 350px; padding: 15px; 
            border-radius: 10px; border: 2px solid #eee; 
            font-family: monospace; font-size: 0.85rem; 
            background: #fafafa; resize: vertical;
        }
        textarea:focus { border-color: #2e7d32; outline: none; background: white; }
        
        button { 
            background: #2e7d32; color: white; padding: 15px; 
            border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; 
            cursor: pointer; width: 100%; margin-top: 15px; 
            transition: transform 0.1s, background 0.2s;
        }
        button:hover { background: #1b5e20; }
        button:active { transform: scale(0.98); }
        
        #status { margin-top: 20px; padding: 15px; border-radius: 8px; font-weight: 500; display: none; line-height: 1.6; }
        .sucesso { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .erro { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        
        .hint { background: #e3f2fd; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 0.9rem; color: #0d47a1; border: 1px solid #bbdefb; }
    </style>
</head>
<body>

<div class="container">
    <h2>ü§ñ Importador com Tags Inteligentes</h2>
    
    <div class="hint">
        üí° <b>Dica:</b> Ao enviar a foto para o Gemini, use o prompt abaixo para ele gerar as tags de busca (sin√¥nimos) e listar as cidades corretamente.
    </div>

    <textarea id="jsonInput" placeholder='Copie este prompt para o Gemini:

"Analise a imagem deste encarte. Extraia os dados em JSON.
1. Se a oferta vale para v√°rias cidades, liste todas em "cidades". Se for para todo o estado, use "RJ".
2. Crie um campo "tags" para cada item com sin√¥nimos populares (sem acento) para facilitar a busca.

Formato Obrigat√≥rio:
{
  "loja": "Supermercados Guanabara",
  "cidades": ["Nova Igua√ßu", "Duque de Caxias", "RJ"],
  "validade": "2026-02-15",
  "itens": [
     { "nome": "Lava Roupas Omo 1kg", "preco": 15.90, "tags": "sabao em po, limpeza, omo, lavagem" },
     { "nome": "Cerveja Heineken Lata", "preco": 4.99, "tags": "bebida, cerveja, alcool, heineken" }
  ]
}"'></textarea>
    
    <button onclick="importar()">üöÄ Processar e Salvar</button>
    <div id="status"></div>
    <div style="text-align:center; margin-top:20px;">
        <a href="index.html" style="color:#666; text-decoration:none;">‚Üê Voltar para Dashboard</a>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://sjhvftndaplufqnrjxcs.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqaHZmdG5kYXBsdWZxbnJqeGNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MDYxMDgsImV4cCI6MjA4MzM4MjEwOH0.bNstvXQ7m2Zt-0UatKmdkxM95-Ft4SRBc1JGGITSnzk';
    
    const clienteSupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    function mostrarStatus(html, tipo) {
        const div = document.getElementById('status');
        div.style.display = 'block';
        div.className = tipo === 'erro' ? 'erro' : 'sucesso';
        div.innerHTML = html;
    }

    async function importar() {
        const texto = document.getElementById('jsonInput').value;
        if(!texto.trim()) return alert("Cole o JSON primeiro!");

        try {
            mostrarStatus("‚è≥ Analisando JSON...", "sucesso");
            
            // Tratamento de erro comum do Gemini (Markdown ```json ... ```)
            let jsonLimpo = texto.replace(/```json/g, '').replace(/```/g, '').trim();
            const dados = JSON.parse(jsonLimpo);
            
            const { data: { session } } = await clienteSupabase.auth.getSession();
            if(!session) return mostrarStatus("‚ùå Fa√ßa login!", "erro");
            const userId = session.user.id;

            // Normaliza lista de cidades
            let listaCidades = [];
            if (Array.isArray(dados.cidades)) {
                listaCidades = dados.cidades;
            } else if (dados.cidade) {
                listaCidades = [dados.cidade];
            } else {
                listaCidades = ['Local n√£o informado'];
            }

            let relatorio = `<b>Processando ${listaCidades.length} locais:</b><br>`;

            for (const nomeCidade of listaCidades) {
                // 1. Busca ou Cria Loja
                let { data: loja } = await clienteSupabase
                    .from('stores')
                    .select('id')
                    .ilike('name', dados.loja)
                    .ilike('city', nomeCidade)
                    .maybeSingle();

                let lojaId;
                
                if (loja) {
                    lojaId = loja.id;
                    // --- VERIFICA√á√ÉO DE DUPLICIDADE ---
                    const hoje = new Date().toISOString().split('T')[0];
                    const { data: duplicata } = await clienteSupabase
                        .from('receipts')
                        .select('id')
                        .eq('store_id', lojaId)
                        .eq('total_amount', 0)
                        .gte('issue_date', hoje)
                        .maybeSingle();

                    if (duplicata) {
                        if(!confirm(`‚ö†Ô∏è J√° existe oferta para ${dados.loja} em ${nomeCidade} hoje.\nDuplicar?`)) {
                            relatorio += `‚ö†Ô∏è <b>${nomeCidade}</b>: Pulado.<br>`;
                            continue;
                        }
                    }
                } else {
                    const { data: novaLoja, error: errLoja } = await clienteSupabase.from('stores').insert({ name: dados.loja, city: nomeCidade }).select().single();
                    if(errLoja) throw errLoja;
                    lojaId = novaLoja.id;
                }

                // 2. Cria Nota
                const { data: nota, error: errNota } = await clienteSupabase.from('receipts').insert({
                    user_id: userId, store_id: lojaId, total_amount: 0, issue_date: new Date().toISOString()
                }).select().single();
                if(errNota) throw errNota;

                // 3. Salva Itens COM TAGS
                const itensParaSalvar = dados.itens.map(item => ({
                    receipt_id: nota.id,
                    raw_name: item.nome,
                    unit_price: parseFloat(item.preco), 
                    total_price: parseFloat(item.preco),
                    quantity: 1,
                    valid_until: dados.validade || null,
                    tags: item.tags || '' // Salva as tags
                }));

                const { error: errItens } = await clienteSupabase.from('receipt_items').insert(itensParaSalvar);
                if(errItens) throw errItens;

                relatorio += `‚úÖ <b>${nomeCidade}</b>: OK!<br>`;
            }

            mostrarStatus(`${relatorio}<br>üèÅ <b>Sucesso Total!</b>`, "sucesso");
            document.getElementById('jsonInput').value = '';

        } catch (e) {
            console.error(e);
            mostrarStatus(`‚ùå Erro no JSON: ${e.message}`, "erro");
        }
    }
</script>
</body>
</html>