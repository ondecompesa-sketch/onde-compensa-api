<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Importar JSON Gemini ü§ñ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 20px; background: #f4f4f9; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #2e7d32; display: flex; align-items: center; gap: 10px; margin-top: 0; }
        
        textarea { 
            width: 100%; height: 300px; padding: 15px; 
            border-radius: 10px; border: 2px solid #eee; 
            font-family: monospace; font-size: 0.9rem; 
            background: #fafafa; resize: vertical;
        }
        textarea:focus { border-color: #2e7d32; outline: none; background: white; }
        
        button { 
            background: #2e7d32; color: white; padding: 15px; 
            border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; 
            cursor: pointer; width: 100%; margin-top: 15px; 
            transition: transform 0.1s, background 0.2s;
        }
        button:hover { background: #1b5e20; }
        button:active { transform: scale(0.98); }
        
        #status { margin-top: 20px; padding: 15px; border-radius: 8px; font-weight: 500; display: none; line-height: 1.6; }
        .sucesso { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .erro { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
    </style>
</head>
<body>

<div class="container">
    <h2>ü§ñ Importador Multi-Lojas</h2>
    <p style="color:#666; margin-bottom:20px;">Cole o JSON do Gemini. Se o encarte for de v√°rias cidades, o sistema vai criar uma oferta para cada cidade automaticamente!</p>
    
    <textarea id="jsonInput" placeholder='{
  "loja": "Royal",
  "cidades": ["Volta Redonda", "Barra Mansa"],
  "validade": "2026-02-20",
  "itens": [...]
}'></textarea>
    
    <button onclick="importar()">üöÄ Processar e Distribuir Ofertas</button>
    <div id="status"></div>
    <div style="text-align:center; margin-top:20px;">
        <a href="index.html" style="color:#666; text-decoration:none;">‚Üê Voltar para Dashboard</a>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://sjhvftndaplufqnrjxcs.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqaHZmdG5kYXBsdWZxbnJqeGNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MDYxMDgsImV4cCI6MjA4MzM4MjEwOH0.bNstvXQ7m2Zt-0UatKmdkxM95-Ft4SRBc1JGGITSnzk';
    
    const clienteSupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    function mostrarStatus(html, tipo) {
        const div = document.getElementById('status');
        div.style.display = 'block';
        div.className = tipo === 'erro' ? 'erro' : 'sucesso';
        div.innerHTML = html;
    }

    async function importar() {
        const texto = document.getElementById('jsonInput').value;
        if(!texto.trim()) return alert("Cole o JSON primeiro!");

        try {
            mostrarStatus("‚è≥ Analisando JSON...", "sucesso");
            const dados = JSON.parse(texto);
            
            // Verifica Login
            const { data: { session } } = await clienteSupabase.auth.getSession();
            if(!session) return mostrarStatus("‚ùå Voc√™ precisa estar logado!", "erro");
            const userId = session.user.id;

            // NORMALIZA AS CIDADES (Transforma string √∫nica em lista se precisar)
            let listaCidades = [];
            if (Array.isArray(dados.cidades)) {
                listaCidades = dados.cidades;
            } else if (dados.cidade) {
                listaCidades = [dados.cidade]; // Se vier no formato antigo (uma s√≥)
            } else {
                listaCidades = ['Local n√£o informado'];
            }

            let relatorio = `<b>Iniciando importa√ß√£o para ${listaCidades.length} locais:</b><br>`;

            // LOOP PRINCIPAL: Repete o processo para cada cidade da lista
            for (const nomeCidade of listaCidades) {
                relatorio += `üìç Processando <b>${nomeCidade}</b>... `;
                
                // 1. Achar ou Criar a Loja Espec√≠fica (Ex: Royal - Volta Redonda)
                // A gente procura pelo Nome E pela Cidade para n√£o misturar
                let { data: loja } = await clienteSupabase
                    .from('stores')
                    .select('id')
                    .ilike('name', dados.loja)
                    .ilike('city', nomeCidade)
                    .maybeSingle();

                let lojaId;
                if (loja) {
                    lojaId = loja.id;
                } else {
                    // Cria loja nova se n√£o existir naquela cidade
                    const { data: novaLoja, error: errLoja } = await clienteSupabase
                        .from('stores')
                        .insert({ name: dados.loja, city: nomeCidade })
                        .select()
                        .single();
                    if(errLoja) throw errLoja;
                    lojaId = novaLoja.id;
                }

                // 2. Criar o Cabe√ßalho da Oferta
                const { data: nota, error: errNota } = await clienteSupabase
                    .from('receipts')
                    .insert({
                        user_id: userId,
                        store_id: lojaId,
                        total_amount: 0,
                        issue_date: new Date().toISOString()
                    })
                    .select().single();
                if(errNota) throw errNota;

                // 3. Salvar os Itens
                const itensParaSalvar = dados.itens.map(item => ({
                    receipt_id: nota.id,
                    raw_name: item.nome,
                    unit_price: parseFloat(item.preco), 
                    total_price: parseFloat(item.preco),
                    quantity: 1,
                    valid_until: dados.validade || null
                }));

                const { error: errItens } = await clienteSupabase
                    .from('receipt_items')
                    .insert(itensParaSalvar);

                if(errItens) throw errItens;

                relatorio += `<span style="color:green">‚úÖ OK!</span><br>`;
            }

            mostrarStatus(`${relatorio}<br><b>üèÅ Tudo pronto! ${dados.itens.length} ofertas espalhadas por todas as filiais.</b>`, "sucesso");
            document.getElementById('jsonInput').value = '';

        } catch (e) {
            console.error(e);
            mostrarStatus(`‚ùå Erro: ${e.message}`, "erro");
        }
    }
</script>
</body>
</html>