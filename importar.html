<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Importar JSON Gemini ü§ñ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 20px; background: #f4f4f9; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #2e7d32; display: flex; align-items: center; gap: 10px; margin-top: 0; }
        
        textarea { 
            width: 100%; height: 300px; padding: 15px; 
            border-radius: 10px; border: 2px solid #eee; 
            font-family: monospace; font-size: 0.9rem; 
            background: #fafafa; resize: vertical;
        }
        textarea:focus { border-color: #2e7d32; outline: none; background: white; }
        
        button { 
            background: #2e7d32; color: white; padding: 15px; 
            border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; 
            cursor: pointer; width: 100%; margin-top: 15px; 
            transition: transform 0.1s, background 0.2s;
        }
        button:hover { background: #1b5e20; }
        button:active { transform: scale(0.98); }
        
        #status { margin-top: 20px; padding: 15px; border-radius: 8px; font-weight: 500; display: none; }
        .sucesso { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .erro { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
    </style>
</head>
<body>

<div class="container">
    <h2>ü§ñ Importador de Encarte (Via Gemini)</h2>
    <p style="color:#666; margin-bottom:20px;">Cole abaixo o JSON que o Gemini gerou a partir da foto do encarte.</p>
    
    <textarea id="jsonInput" placeholder='Cole o c√≥digo JSON aqui...
Exemplo:
{
  "loja": "Mundial",
  "cidade": "Rio de Janeiro - RJ",
  "validade": "2026-01-20",
  "itens": [ ... ]
}'></textarea>
    
    <button onclick="importar()">üöÄ Processar e Salvar no Banco</button>
    <div id="status"></div>
    <div style="text-align:center; margin-top:20px;">
        <a href="index.html" style="color:#666; text-decoration:none;">‚Üê Voltar para Dashboard</a>
    </div>
</div>

<script>
    // --- CONFIGURA√á√ÉO ---
    const SUPABASE_URL = 'https://sjhvftndaplufqnrjxcs.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqaHZmdG5kYXBsdWZxbnJqeGNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MDYxMDgsImV4cCI6MjA4MzM4MjEwOH0.bNstvXQ7m2Zt-0UatKmdkxM95-Ft4SRBc1JGGITSnzk';
    
    // Mudei o nome da vari√°vel para evitar conflito
    const clienteSupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    function mostrarStatus(msg, tipo) {
        const div = document.getElementById('status');
        div.style.display = 'block';
        div.className = tipo === 'erro' ? 'erro' : 'sucesso';
        div.innerHTML = msg;
    }

    async function importar() {
        const texto = document.getElementById('jsonInput').value;
        if(!texto.trim()) return alert("Cole o JSON primeiro!");

        try {
            mostrarStatus("‚è≥ Lendo e validando JSON...", "sucesso");
            
            // Tenta corrigir aspas simples se o Gemini mandar errado, s√≥ por garantia
            const jsonLimpo = texto.replace(/'/g, '"'); 
            const dados = JSON.parse(texto); // Tenta ler o original primeiro
            
            // 1. Verifica login
            const { data: { session } } = await clienteSupabase.auth.getSession();
            if(!session) {
                mostrarStatus("‚ùå Voc√™ precisa estar logado! <a href='login.html'>Ir para Login</a>", "erro");
                return;
            }
            const userId = session.user.id;

            // 2. Busca ou Cria a Loja
            mostrarStatus(`üè¨ Verificando loja: <b>${dados.loja}</b>...`, "sucesso");
            
            let { data: lojaExistente } = await clienteSupabase
                .from('stores')
                .select('id')
                .ilike('name', dados.loja)
                .maybeSingle(); // Usa maybeSingle para n√£o dar erro se n√£o achar

            let lojaId;

            if (lojaExistente) {
                lojaId = lojaExistente.id;
            } else {
                // Cria loja nova
                const { data: novaLoja, error: erroLoja } = await clienteSupabase
                    .from('stores')
                    .insert({ name: dados.loja, city: dados.cidade || 'Local n√£o informado' })
                    .select()
                    .single();
                
                if(erroLoja) throw new Error("Erro ao criar loja: " + erroLoja.message);
                lojaId = novaLoja.id;
            }

            // 3. Cria o "Cabe√ßalho" da Oferta
            mostrarStatus("üìÑ Criando registro do encarte...", "sucesso");
            const { data: nota, error: erroNota } = await clienteSupabase
                .from('receipts')
                .insert({
                    user_id: userId,
                    store_id: lojaId,
                    total_amount: 0,
                    issue_date: new Date().toISOString()
                })
                .select()
                .single();

            if(erroNota) throw new Error("Erro ao criar nota: " + erroNota.message);

            // 4. Prepara os Itens
            mostrarStatus(`üì¶ Processando ${dados.itens.length} itens...`, "sucesso");
            
            // Garante que o pre√ßo venha como n√∫mero, mesmo se o JSON vier como string "10.90"
            const itensParaSalvar = dados.itens.map(item => ({
                receipt_id: nota.id,
                raw_name: item.nome,
                unit_price: parseFloat(item.preco), 
                total_price: parseFloat(item.preco),
                quantity: 1,
                valid_until: dados.validade || null
            }));

            // 5. Salva Itens
            const { error: erroItens } = await clienteSupabase
                .from('receipt_items')
                .insert(itensParaSalvar);

            if(erroItens) throw new Error("Erro ao salvar itens: " + erroItens.message);

            mostrarStatus(`‚úÖ <b>Sucesso Absoluto!</b><br>${dados.itens.length} ofertas importadas para o <b>${dados.loja}</b>.<br><a href='index.html'>Ver no Painel</a>`, "sucesso");
            document.getElementById('jsonInput').value = ''; // Limpa a √°rea

        } catch (e) {
            console.error(e);
            mostrarStatus(`‚ùå <b>Erro:</b> ${e.message}<br>Verifique se o JSON est√° correto.`, "erro");
        }
    }
</script>
</body>
</html>