<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Importar Ofertas (IA) ü§ñ</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 20px; background: #f4f4f9; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #2e7d32; display: flex; align-items: center; gap: 10px; margin-top: 0; }
        
        textarea { 
            width: 100%; height: 350px; padding: 15px; 
            border-radius: 10px; border: 2px solid #eee; 
            font-family: monospace; font-size: 0.85rem; 
            background: #fafafa; resize: vertical; white-space: pre; overflow-x: auto;
        }
        textarea:focus { border-color: #2e7d32; outline: none; background: white; }
        
        button { 
            background: #2e7d32; color: white; padding: 15px; 
            border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; 
            cursor: pointer; width: 100%; margin-top: 15px; 
            transition: transform 0.1s, background 0.2s;
        }
        button:hover { background: #1b5e20; }
        button:active { transform: scale(0.98); }
        
        #status { margin-top: 20px; padding: 15px; border-radius: 8px; font-weight: 500; display: none; line-height: 1.6; word-wrap: break-word; }
        .sucesso { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .erro { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .erro code { background: rgba(255,0,0,0.1); padding: 2px 5px; border-radius: 4px; font-family: monospace; display: block; margin: 10px 0; white-space: pre-wrap; }
        
        .hint { background: #e3f2fd; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 0.9rem; color: #0d47a1; border: 1px solid #bbdefb; }
    </style>
</head>
<body>

<div class="container">
    <h2>ü§ñ Importador (Vers√£o Detetive)</h2>
    
    <div class="hint">
        üí° <b>Dica:</b> Se der erro, o sistema agora vai mostrar qual linha est√° com problema para voc√™ corrigir manualmente (geralmente falta uma v√≠rgula).
    </div>

    <textarea id="jsonInput" placeholder='Cole o JSON do Gemini aqui...'></textarea>
    
    <button onclick="importar()">üöÄ Processar e Salvar</button>
    <div id="status"></div>
    <div style="text-align:center; margin-top:20px;">
        <a href="index.html" style="color:#666; text-decoration:none;">‚Üê Voltar para Dashboard</a>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://sjhvftndaplufqnrjxcs.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqaHZmdG5kYXBsdWZxbnJqeGNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MDYxMDgsImV4cCI6MjA4MzM4MjEwOH0.bNstvXQ7m2Zt-0UatKmdkxM95-Ft4SRBc1JGGITSnzk';
    
    // Verifica se a biblioteca carregou antes de tentar usar
    let clienteSupabase = null;
    if (window.supabase) {
        clienteSupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } else {
        alert("‚ö†Ô∏è A biblioteca do Supabase n√£o carregou. Verifique sua conex√£o ou recarregue a p√°gina.");
    }

    function mostrarStatus(html, tipo) {
        const div = document.getElementById('status');
        div.style.display = 'block';
        div.className = tipo === 'erro' ? 'erro' : 'sucesso';
        div.innerHTML = html;
    }

    async function importar() {
        if (!clienteSupabase) return alert("Erro cr√≠tico: Supabase n√£o carregado.");
        
        const inputRaw = document.getElementById('jsonInput').value;
        if(!inputRaw.trim()) return alert("Cole o JSON primeiro!");

        try {
            mostrarStatus("‚è≥ Analisando JSON...", "sucesso");
            
            // 1. LIMPEZA INICIAL
            let jsonLimpo = inputRaw
                .replace(/```json/g, '')
                .replace(/```/g, '')
                .trim();

            // Tenta corrigir erro comum: objetos colados "}{" vira "},{"
            jsonLimpo = jsonLimpo.replace(/}\s*{/g, '},{');

            // 2. TENTATIVA DE PARSE
            let dados;
            try {
                dados = JSON.parse(jsonLimpo);
            } catch (e) {
                // --- MODO DETETIVE: Encontra onde est√° o erro ---
                // O erro geralmente diz a posi√ß√£o (ex: position 8153)
                const match = e.message.match(/position (\d+)/);
                if (match) {
                    const pos = parseInt(match[1]);
                    const inicio = Math.max(0, pos - 50);
                    const fim = Math.min(jsonLimpo.length, pos + 50);
                    const trecho = jsonLimpo.substring(inicio, fim);
                    
                    // Destaca o erro
                    const trechoDestacado = trecho.slice(0, 50) + " üëâüõëüëà " + trecho.slice(50);
                    
                    throw new Error(`Erro de sintaxe pr√≥ximo a este trecho:\n\n...${trechoDestacado}...\n\nO que verificar:\n1. Falta uma v√≠rgula (,) entre itens?\n2. Falta fechar aspas (")?\n3. Tem uma v√≠rgula sobrando no final?`);
                } else {
                    throw e;
                }
            }

            // 3. PROCESSAMENTO (Igual ao anterior)
            const listaOfertas = Array.isArray(dados) ? dados : [dados];
            
            const { data: { session } } = await clienteSupabase.auth.getSession();
            if(!session) return mostrarStatus("‚ùå Fa√ßa login!", "erro");
            const userId = session.user.id;

            let relatorio = `<b>Processando ${listaOfertas.length} encarte(s):</b><br>`;

            for (const oferta of listaOfertas) {
                let listaCidades = [];
                if (Array.isArray(oferta.cidades)) listaCidades = oferta.cidades;
                else if (oferta.cidade) listaCidades = [oferta.cidade];
                else listaCidades = ['Local n√£o informado'];

                relatorio += `<hr style="opacity:0.3">üõí <b>${oferta.loja}</b>:<br>`;

                for (const nomeCidade of listaCidades) {
                    let { data: loja } = await clienteSupabase.from('stores').select('id').ilike('name', oferta.loja).ilike('city', nomeCidade).maybeSingle();

                    let lojaId;
                    if (loja) {
                        lojaId = loja.id;
                        const hoje = new Date().toISOString().split('T')[0];
                        const { data: duplicata } = await clienteSupabase.from('receipts').select('id').eq('store_id', lojaId).eq('total_amount', 0).gte('issue_date', hoje).maybeSingle();

                        if (duplicata) {
                            relatorio += `‚ö†Ô∏è <b>${nomeCidade}</b>: J√° existe hoje (Pulado).<br>`;
                            continue; 
                        }
                    } else {
                        const { data: novaLoja, error: errLoja } = await clienteSupabase.from('stores').insert({ name: oferta.loja, city: nomeCidade }).select().single();
                        if(errLoja) throw errLoja;
                        lojaId = novaLoja.id;
                    }

                    const { data: nota, error: errNota } = await clienteSupabase.from('receipts').insert({
                        user_id: userId, store_id: lojaId, total_amount: 0, issue_date: new Date().toISOString()
                    }).select().single();
                    if(errNota) throw errNota;

                    const itensParaSalvar = oferta.itens.map(item => ({
                        receipt_id: nota.id, raw_name: item.nome, unit_price: parseFloat(item.preco), total_price: parseFloat(item.preco), quantity: 1, valid_until: oferta.validade || null, tags: item.tags || ''
                    }));

                    const { error: errItens } = await clienteSupabase.from('receipt_items').insert(itensParaSalvar);
                    if(errItens) throw errItens;

                    relatorio += `‚úÖ <b>${nomeCidade}</b>: Sucesso (${oferta.itens.length} itens)<br>`;
                }
            }

            mostrarStatus(`${relatorio}<br>üèÅ <b>Processo Finalizado!</b>`, "sucesso");
            document.getElementById('jsonInput').value = '';

        } catch (e) {
            console.error(e);
            mostrarStatus(`‚ùå <b>JSON Inv√°lido:</b><br>${e.message}`, "erro");
        }
    }
</script>
</body>
</html>