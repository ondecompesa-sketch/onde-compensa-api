<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Meu Perfil</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background: #f4f7fa; padding: 20px; color: #333; }
        .container { max-width: 500px; margin: 0 auto; }
        
        .profile-header { text-align: center; margin-bottom: 30px; }
        .avatar { width: 100px; height: 100px; border-radius: 50%; background: #ddd; margin-bottom: 10px; object-fit: cover; border: 4px solid white; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 20px; }
        
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; font-size: 0.9rem; }
        input { width: 100%; padding: 14px; border: 1px solid #eee; border-radius: 12px; font-size: 1rem; margin-bottom: 20px; background: #f9f9f9; outline: none; transition: 0.2s; }
        input:focus { border-color: #007bff; background: white; }
        
        .btn-save { background: #007bff; color: white; border: none; padding: 16px; width: 100%; border-radius: 12px; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .btn-logout { background: #ffebee; color: #c62828; border: none; padding: 16px; width: 100%; border-radius: 12px; font-weight: bold; font-size: 1rem; cursor: pointer; margin-top: 10px; }
        
        .fab-back { position: fixed; bottom: 25px; left: 25px; background: white; color: #333; width: 55px; height: 55px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 20px rgba(0,0,0,0.15); text-decoration: none; font-size: 24px; z-index: 200; }
    </style>
</head>
<body>

<div class="container">
    <div class="profile-header">
        <img id="img-avatar" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" class="avatar">
        <h2 id="txt-nome" style="margin:0;">Carregando...</h2>
        <p id="txt-email" style="color:#888; margin:5px 0 0 0; font-size:0.9rem;">...</p>
    </div>

    <div class="card">
        <label>üìç Cidade Padr√£o (Filtro Autom√°tico)</label>
        <input type="text" id="inp-cidade" placeholder="Ex: Nova Igua√ßu">

        <label>üéØ Meta de Gastos Mensal (R$)</label>
        <input type="number" id="inp-meta" placeholder="Ex: 2000.00">

        <button class="btn-save" onclick="salvarPerfil()">üíæ Salvar Altera√ß√µes</button>
    </div>

    <button class="btn-logout" onclick="sair()">üö™ Sair da Conta</button>
</div>

<a href="index.html" class="fab-back">‚¨Ö</a>

<script>
    const SUPABASE_URL = 'https://sjhvftndaplufqnrjxcs.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqaHZmdG5kYXBsdWZxbnJqeGNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MDYxMDgsImV4cCI6MjA4MzM4MjEwOH0.bNstvXQ7m2Zt-0UatKmdkxM95-Ft4SRBc1JGGITSnzk';
    const cliente = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function carregar() {
        const { data: { session } } = await cliente.auth.getSession();
        if(!session) return window.location.href = 'login.html';

        const user = session.user;
        document.getElementById('txt-email').innerText = user.email;
        document.getElementById('txt-nome').innerText = user.user_metadata.full_name || 'Usu√°rio';
        if(user.user_metadata.avatar_url) document.getElementById('img-avatar').src = user.user_metadata.avatar_url;

        // Carrega dados do perfil
        let { data: perfil } = await cliente.from('profiles').select('*').eq('id', user.id).single();
        
        // Se n√£o existir perfil (usu√°rios antigos), cria um agora
        if (!perfil) {
            const { data: novo } = await cliente.from('profiles').insert({ id: user.id }).select().single();
            perfil = novo;
        }

        if(perfil) {
            document.getElementById('inp-cidade').value = perfil.city || '';
            document.getElementById('inp-meta').value = perfil.monthly_goal || '';
            
            // Sincroniza com localStorage para o index.html usar r√°pido
            if(perfil.city) localStorage.setItem('minhaCidade', perfil.city);
        }
    }

    async function salvarPerfil() {
        const cidade = document.getElementById('inp-cidade').value;
        const meta = document.getElementById('inp-meta').value;
        
        const { data: { session } } = await cliente.auth.getSession();
        
        const { error } = await cliente.from('profiles')
            .update({ city: cidade, monthly_goal: meta })
            .eq('id', session.user.id);

        if(error) alert('Erro ao salvar: ' + error.message);
        else {
            localStorage.setItem('minhaCidade', cidade); // Atualiza cache local
            alert('Perfil atualizado com sucesso! ‚úÖ');
        }
    }

    async function sair() {
        await cliente.auth.signOut();
        window.location.href = 'login.html';
    }

    carregar();
</script>
</body>
</html>