<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lista Inteligente üõí</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2e7d32">
    <meta name="mobile-web-app-capable" content="yes">

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background: #f4f7fa; padding: 20px; padding-bottom: 140px; color: #333; }
        .container { max-width: 600px; margin: 0 auto; }
        
        /* HEADER COM VOLTAR E TOTAL */
        .header-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        h1 { color: #2e7d32; font-size: 1.5rem; margin: 0; display: flex; align-items: center; gap: 10px; }
        .fab-back { background: white; color: #333; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-decoration: none; font-weight: bold; }

        /* PAINEL DE OR√áAMENTO (NOVO) */
        .budget-card { background: linear-gradient(135deg, #2e7d32 0%, #43a047 100%); color: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(46, 125, 50, 0.3); display: flex; justify-content: space-between; align-items: center; }
        .budget-info h2 { margin: 0; font-size: 1.8rem; font-weight: 800; }
        .budget-info span { font-size: 0.85rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }
        .item-count { background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; }
        
        /* INPUTS MELHORADOS */
        .input-group { background: white; padding: 15px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px; }
        .row-inputs { display: flex; gap: 10px; }
        input { padding: 12px; border: 1px solid #eee; border-radius: 10px; font-size: 1rem; outline: none; background: #fafafa; transition: 0.2s; }
        input:focus { background: white; border-color: #2e7d32; }
        .input-nome { width: 100%; }
        .input-curto { flex: 1; text-align: center; }
        .btn-add { background: #2e7d32; color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; font-size: 1rem; cursor: pointer; transition: 0.2s; }
        .btn-add:active { transform: scale(0.98); }
        
        /* LISTA */
        .list-container { display: flex; flex-direction: column; gap: 10px; }
        .list-item { background: white; padding: 15px; border-radius: 14px; display: flex; flex-direction: column; gap: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); position: relative; border-left: 5px solid #ddd; transition: 0.3s; }
        
        .item-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .item-info { display: flex; flex-direction: column; }
        .item-name { font-weight: 600; font-size: 1.1rem; color: #333; }
        .item-meta { font-size: 0.85rem; color: #666; }
        
        .item-total { font-weight: 800; color: #2e7d32; font-size: 1.1rem; }
        .btn-del { color: #ef5350; background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 0 0 0 10px; }

        /* STATUS DA BUSCA */
        .best-price-badge { background: #e8f5e9; color: #1b5e20; padding: 8px; border-radius: 8px; font-size: 0.85rem; margin-top: 5px; display: none; border: 1px solid #c8e6c9; }
        .list-item.loading { border-left-color: #ff9800; }
        .list-item.loading .best-price-badge { display: block; background: #fff3e0; color: #e65100; border-color: #ffe0b2; }
        .list-item.found { border-left-color: #2e7d32; }
        .list-item.found .best-price-badge { display: block; }
        .list-item.not-found { border-left-color: #607d8b; }
        .list-item.not-found .best-price-badge { display: block; background: #eceff1; color: #607d8b; border-color: #cfd8dc; }

        /* BARRA DE A√á√ïES INFERIOR */
        .bottom-actions { position: fixed; bottom: 20px; left: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 100; }
        .btn-analyze { background: #007bff; color: white; padding: 16px; border-radius: 15px; font-weight: bold; font-size: 1.1rem; border: none; box-shadow: 0 4px 15px rgba(0,123,255,0.3); cursor: pointer; display: flex; justify-content: center; gap: 10px; width: 100%; transition: 0.2s; }
        .btn-analyze:active { transform: scale(0.98); }
        .secondary-actions { display: flex; gap: 10px; }
        .btn-share { flex: 2; background: #25D366; color: white; padding: 14px; border-radius: 12px; font-weight: bold; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 10px rgba(37, 211, 102, 0.3); }
        .btn-clear { flex: 1; background: #ffebee; color: #c62828; padding: 14px; border-radius: 12px; font-weight: bold; border: none; cursor: pointer; }
    </style>
</head>
<body>

<div class="header-top">
    <a href="index.html" class="fab-back">‚úï</a>
    <h1>Minha Lista</h1>
</div>

<div class="container">
    <div class="budget-card">
        <div class="budget-info">
            <span>Total Estimado</span>
            <h2 id="total-display">R$ 0,00</h2>
        </div>
        <div class="item-count" id="count-display">0 itens</div>
    </div>

    <div class="input-group">
        <input type="text" id="inp-item" class="input-nome" placeholder="Nome do produto (ex: Arroz 5kg)">
        <div class="row-inputs">
            <input type="number" id="inp-qtd" class="input-curto" placeholder="Qtd" value="1">
            <input type="number" id="inp-preco" class="input-curto" placeholder="Pre√ßo Est." step="0.01">
        </div>
        <button class="btn-add" onclick="adicionar()">Ôºã Adicionar √† Lista</button>
    </div>

    <div id="lista" class="list-container"></div>
</div>

<div class="bottom-actions">
    <button class="btn-analyze" onclick="analisarPrecos()">
        <span>üîç</span> Ver Onde Comprar
    </button>
    
    <div class="secondary-actions">
        <button class="btn-share" onclick="compartilharZap()">
            üì± Enviar Zap
        </button>
        <button class="btn-clear" onclick="limparLista()">
            üóëÔ∏è Limpar
        </button>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://sjhvftndaplufqnrjxcs.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqaHZmdG5kYXBsdWZxbnJqeGNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MDYxMDgsImV4cCI6MjA4MzM4MjEwOH0.bNstvXQ7m2Zt-0UatKmdkxM95-Ft4SRBc1JGGITSnzk';
    const cliente = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Recupera lista antiga ou inicia nova
    let listaItems = JSON.parse(localStorage.getItem('minhaLista') || '[]');
    const minhaCidade = localStorage.getItem('minhaCidade') || '';

    // Garante compatibilidade se o usu√°rio tiver dados da vers√£o antiga (sem qtd/precoManual)
    listaItems = listaItems.map(item => ({
        ...item,
        qtd: item.qtd || 1,
        precoManual: item.precoManual || 0,
        precoNum: item.precoNum || 0
    }));

    function renderizar() {
        const div = document.getElementById('lista');
        const totalEl = document.getElementById('total-display');
        const countEl = document.getElementById('count-display');
        
        div.innerHTML = '';
        let totalGeral = 0;
        let totalQtd = 0;

        if(listaItems.length === 0) {
            div.innerHTML = '<div style="text-align:center; padding:30px; color:#999;">Sua lista est√° vazia.<br>Comece a planejar! üõí</div>';
            totalEl.innerText = "R$ 0,00";
            countEl.innerText = "0 itens";
            return;
        }

        listaItems.forEach((item, index) => {
            // L√ìGICA DO PRE√áO: Se o sistema achou um pre√ßo (precoNum), usa ele. Se n√£o, usa o manual.
            const precoEfetivo = item.precoNum > 0 ? item.precoNum : item.precoManual;
            const subtotal = precoEfetivo * item.qtd;
            
            totalGeral += subtotal;
            totalQtd += item.qtd;

            const el = document.createElement('div');
            el.className = `list-item ${item.status || ''}`;
            el.id = `item-${index}`;
            
            // Texto descritivo (ex: "3x de R$ 5,00")
            const textoPreco = precoEfetivo > 0 
                ? `${item.qtd}x de ${precoEfetivo.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}` 
                : `${item.qtd} un. (Sem pre√ßo)`;

            el.innerHTML = `
                <div class="item-header">
                    <div class="item-info">
                        <span class="item-name">${item.nome}</span>
                        <span class="item-meta">${textoPreco}</span>
                    </div>
                    <div style="display:flex; align-items:center;">
                        <span class="item-total">${subtotal > 0 ? subtotal.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}) : '--'}</span>
                        <button class="btn-del" onclick="remover(${index})">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="best-price-badge" id="badge-${index}">
                    ${item.resultado || ''}
                </div>
            `;
            div.appendChild(el);
        });

        totalEl.innerText = totalGeral.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
        countEl.innerText = `${totalQtd} itens`;
        localStorage.setItem('minhaLista', JSON.stringify(listaItems));
    }

    function adicionar() {
        const inpNome = document.getElementById('inp-item');
        const inpQtd = document.getElementById('inp-qtd');
        const inpPreco = document.getElementById('inp-preco');

        const nome = inpNome.value.trim();
        const qtd = parseFloat(inpQtd.value) || 1;
        const precoManual = parseFloat(inpPreco.value.replace(',', '.')) || 0;

        if(!nome) return alert("Digite o nome do produto!");

        // Adiciona novo item completo
        listaItems.unshift({ 
            nome, 
            qtd, 
            precoManual, 
            status: '', 
            resultado: '', 
            precoNum: 0 
        });
        
        // Limpa campos
        inpNome.value = '';
        inpQtd.value = '1';
        inpPreco.value = '';
        inpNome.focus();
        
        renderizar();
    }

    function remover(i) {
        if(confirm("Remover este item?")) {
            listaItems.splice(i, 1);
            renderizar();
        }
    }
    
    function limparLista() {
        if(confirm("Tem certeza que deseja apagar a lista toda?")) {
            listaItems = [];
            renderizar();
        }
    }

    // --- C√âREBRO DA OPERA√á√ÉO üß† (BUSCA NO SUPABASE) ---
    async function analisarPrecos() {
        const btn = document.querySelector('.btn-analyze');
        btn.innerHTML = '‚è≥ Pesquisando...'; btn.disabled = true;

        for (let i = 0; i < listaItems.length; i++) {
            const item = listaItems[i];
            const badge = document.getElementById(`badge-${i}`);
            const card = document.getElementById(`item-${i}`);
            
            // S√≥ pesquisa se ainda n√£o encontrou ou se for for√ßado
            if(item.status === 'found') continue; 

            card.classList.remove('found', 'not-found');
            card.classList.add('loading');
            if(badge) badge.innerText = 'Pesquisando pre√ßos...';

            try {
                let { data } = await cliente.rpc('buscar_produtos', { termo: item.nome })
                    .select(`
                        unit_price, valid_until,
                        receipt:receipts ( store:stores ( name, city ) )
                    `)
                    .limit(20);

                if (!data) data = [];

                // Filtra por cidade
                let ofertas = data.filter(d => {
                    if(!d.receipt?.store) return false;
                    const cidadeLoja = (d.receipt.store.city || '').toLowerCase();
                    const cMinha = minhaCidade.toLowerCase();
                    const chaves = ['rj', 'rio de janeiro', 'todas', 'brasil'];
                    if(!minhaCidade) return true;
                    if(chaves.some(k => cidadeLoja.includes(k))) return true;
                    return cidadeLoja.includes(cMinha);
                });

                ofertas.sort((a, b) => a.unit_price - b.unit_price);
                card.classList.remove('loading');
                
                if (ofertas.length > 0) {
                    const melhor = ofertas[0];
                    const nomeLoja = melhor.receipt.store.name;
                    item.precoNum = parseFloat(melhor.unit_price); // Atualiza o pre√ßo real!
                    
                    const precoFmt = item.precoNum.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                    const hoje = new Date().toISOString().split('T')[0];
                    let icone = 'üí∞';
                    if (melhor.valid_until && melhor.valid_until >= hoje) icone = 'üî• Oferta';

                    item.resultado = `${icone}: <b>${precoFmt}</b> no <b>${nomeLoja}</b>`;
                    item.status = 'found';
                } else {
                    // Se n√£o achou, mant√©m o pre√ßo manual se houver
                    item.resultado = item.precoManual > 0 
                        ? `Pre√ßo online n√£o encontrado. Usando seu manual.`
                        : `Nenhum pre√ßo encontrado.`;
                    item.status = 'not-found';
                    item.precoNum = 0; // Zera para o sistema usar o Manual
                }

            } catch (e) {
                console.error(e);
                item.resultado = "Erro na busca.";
            }
            // Renderiza a cada item para ir atualizando o Total l√° em cima em tempo real!
            renderizar(); 
        }
        btn.innerHTML = '<span>üîç</span> Atualizar Pre√ßos'; btn.disabled = false;
    }

    // --- WHATSAPP COM QUANTIDADES E TOTAIS ---
    function compartilharZap() {
        if(listaItems.length === 0) return alert("Lista vazia!");

        let texto = `üõí *Minha Lista de Compras* (${minhaCidade || 'Geral'})\n\n`;
        let totalZap = 0;

        listaItems.forEach(item => {
            const check = item.status === 'found' ? '‚úÖ' : (item.precoManual > 0 ? 'üìù' : '‚¨ú');
            const precoEfetivo = item.precoNum > 0 ? item.precoNum : item.precoManual;
            const subtotal = precoEfetivo * item.qtd;
            totalZap += subtotal;

            // Limpa HTML para texto puro
            let info = "";
            if(item.status === 'found') {
                info = item.resultado.replace(/<[^>]*>/g, '').replace('üî• Oferta:', '').replace('üí∞:', '').trim();
            } else if (item.precoManual > 0) {
                info = `Or√ßado: R$ ${item.precoManual.toFixed(2)}`;
            }

            texto += `${check} *${item.qtd}x ${item.nome}*\n`;
            if(info) texto += `   ‚Ü≥ ${info}\n`;
        });

        if(totalZap > 0) {
            texto += `\nüí∞ *Total Estimado: R$ ${totalZap.toLocaleString('pt-BR', {minimumFractionDigits: 2})}*`;
        }
        
        texto += `\n\n_Gerado por OndeCompensa App_`;
        const url = `https://wa.me/?text=${encodeURIComponent(texto)}`;
        window.open(url, '_blank');
    }

    // Inicia
    renderizar();
</script>
</body>
</html>