<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova Nota - OndeCompensa</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f6f8; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .card { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        h1 { color: #333; margin-bottom: 10px; }
        p { color: #666; margin-bottom: 30px; }
        
        .upload-area { border: 2px dashed #007bff; border-radius: 12px; padding: 40px 20px; cursor: pointer; transition: 0.2s; background: #f8fbff; margin-bottom: 20px; position: relative; }
        .upload-area:hover { background: #eef6ff; }
        .upload-icon { font-size: 3em; margin-bottom: 10px; display: block; }
        
        #fileInput { display: none; }
        
        .btn { width: 100%; padding: 15px; background: #007bff; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.1em; transition: 0.2s; }
        .btn:hover { background: #0056b3; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-voltar { background: transparent; color: #666; border: 1px solid #ddd; margin-top: 10px; }
        .btn-voltar:hover { background: #eee; }

        /* Anima√ß√£o de Loading */
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 100; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { font-weight: bold; color: #555; font-size: 1.1em; }
        .loading-subtext { font-size: 0.9em; color: #888; margin-top: 5px; }
    </style>
</head>
<body>

<div class="card">
    <h1>üì∏ Nova Compra</h1>
    <p>Tire uma foto leg√≠vel da sua nota fiscal (NFC-e).</p>

    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <span class="upload-icon">üì∑</span>
        <span id="upload-text">Toque para tirar foto ou escolher da galeria</span>
        
        <input type="file" id="fileInput" accept="image/*" onchange="mostrarPreview()">
    
    </div>
    <img id="preview" style="max-width: 100%; border-radius: 8px; display: none; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">

    <button onclick="enviarNota()" id="btn-enviar" class="btn" disabled>Processar Nota</button>
    <button onclick="voltar()" class="btn btn-voltar">Cancelar</button>
</div>

<div class="loading-overlay" id="loading">
    <div class="spinner"></div>
    <div class="loading-text">Analisando sua nota...</div>
    <div class="loading-subtext">A Intelig√™ncia Artificial est√° lendo os itens.<br>Isso pode levar uns 15 segundos.</div>
</div>

<script>
    // --- ‚ö†Ô∏è SUAS CHAVES DO SUPABASE ---
    const SUPABASE_URL = 'https://sjhvftndaplufqnrjxcs.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqaHZmdG5kYXBsdWZxbnJqeGNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MDYxMDgsImV4cCI6MjA4MzM4MjEwOH0.bNstvXQ7m2Zt-0UatKmdkxM95-Ft4SRBc1JGGITSnzk';
    // -----------------------------------------------

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const API_URL = 'https://onde-compensa-api.onrender.com';

    let fileSelecionado = null;
    let userId = null;

    async function checarLogin() {
        const { data } = await supabaseClient.auth.getSession();
        if (!data.session) return window.location.href = 'login.html';
        userId = data.session.user.id;
    }
    checarLogin();

    function mostrarPreview() {
        const input = document.getElementById('fileInput');
        const preview = document.getElementById('preview');
        const btn = document.getElementById('btn-enviar');
        const texto = document.getElementById('upload-text');

        if (input.files && input.files[0]) {
            fileSelecionado = input.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
                texto.innerText = "Trocar foto";
                btn.disabled = false;
                btn.innerText = "Processar Nota";
            }
            
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function enviarNota() {
        if (!fileSelecionado || !userId) return;

        // Mostra Loading
        document.getElementById('loading').style.display = 'flex';
        
        const formData = new FormData();
        formData.append('file', fileSelecionado);
        formData.append('userId', userId); 

        try {
            console.log("Enviando para API...");
            
            const response = await fetch(`${API_URL}/upload`, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const erroTexto = await response.text();
                throw new Error(erroTexto || 'Erro no servidor');
            }

            const resultado = await response.json();
            console.log("Sucesso:", resultado);
            
            // CORRE√á√ÉO: Vai para index.html (o novo dashboard)
            window.location.href = 'index.html';

        } catch (error) {
            console.error(error);
            alert("Ocorreu um erro ao processar: " + error.message);
            document.getElementById('loading').style.display = 'none';
        }
    }

    function voltar() {
        // CORRE√á√ÉO: Vai para index.html
        window.location.href = 'index.html';
    }
</script>

</body>
</html>